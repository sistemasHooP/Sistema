<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwt5wH_wT65wfXyaBc78YK4ZBHcCi7zFATSQRk6yytCTHFlqCLs1Gc7JSS395aYNUmR/exec";
    let currentCompetencia = "";
    let authToken = localStorage.getItem('rpps_token');
    let currentUser = localStorage.getItem('rpps_user');
    
    let confirmCallback = null;
    let CACHE = {};
    let pendingHighlightId = null;
    
    let financeChart = null;

    // --- 1. FUNÇÕES GLOBAIS E UTILITÁRIAS ---
    
    function formatCurrency(v) { 
        if(v === undefined || v === null || v === '') return 'R$ 0,00';
        if(typeof v === 'number') return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        let str = v.toString();
        if(str.includes(',')) { str = str.replace(/\./g, '').replace(',', '.'); }
        str = str.replace(/[R$\s]/g, '');
        return parseFloat(str || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); 
    }
    
    function parseValue(v) {
        if(typeof v === 'number') return v;
        if(!v) return 0;
        let str = v.toString();
        if(str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
        str = str.replace(/[R$\s]/g, '');
        return parseFloat(str || 0);
    }

    function showToast(msg, type) { 
        const t = document.getElementById('toast'); 
        document.getElementById('toast-msg').innerText = msg; 
        t.className = type; 
        t.classList.add('show'); 
        setTimeout(() => t.classList.remove('show'), 3000); 
    }

    function setupMoneyMask() { 
        document.querySelectorAll('.money-mask').forEach(i => i.addEventListener('input', e => { 
            let v = e.target.value.replace(/\D/g,""); 
            v = (v/100).toFixed(2) + ""; 
            e.target.value = "R$ " + v.replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."); 
        })); 
    }

    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
    function setLoading(act) { document.getElementById('loadingOverlay').classList.toggle('hidden', !act); }

    function openConfirm(msg, callback) { 
        document.getElementById('confirm-msg').innerText = msg; 
        document.getElementById('modal-confirm').classList.remove('hidden'); 
        confirmCallback = callback; 
    }
    
    function closeConfirm(yes) { 
        document.getElementById('modal-confirm').classList.add('hidden'); 
        if(yes && confirmCallback) confirmCallback(); 
        confirmCallback = null; 
    }

    function calcularLiquidoVisual(form) {
        const bruto = parseFloat(form.valorBruto.value.replace(/\D/g, '') || 0) / 100;
        const desc = parseFloat(form.valorDescontos.value.replace(/\D/g, '') || 0) / 100;
        const liq = bruto - desc;
        const div = form.querySelector('div[id^="display-liquido"]');
        if(div) div.innerText = "Líquido: " + liq.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    }

    // --- NOVA FUNÇÃO: CALCULAR MARGEM VISUAL ---
    function calcularMargemVisual(form) {
        const bruto = parseValue(form.querySelector('[name="bruto"]').value);
        const descontos = parseValue(form.querySelector('[name="descontos"]').value);
        const usoAtual = parseValue(form.querySelector('[name="usoAtual"]').value);
        const porcentagem = parseFloat(form.querySelector('[name="porcentagem"]').value) || 35;

        const liquido = bruto - descontos;
        const margemPermitida = liquido * (porcentagem / 100);
        const disponivel = margemPermitida - usoAtual;

        document.getElementById('display-calc-liquido').innerText = formatCurrency(liquido);
        document.getElementById('display-calc-permitida').innerText = formatCurrency(margemPermitida);
        document.getElementById('display-calc-disponivel').innerText = formatCurrency(disponivel);

        form.querySelector('[name="liquido"]').value = liquido.toFixed(2);
        form.querySelector('[name="margemPermitida"]').value = margemPermitida.toFixed(2);
        form.querySelector('[name="disponivel"]').value = disponivel.toFixed(2);
        
        const dispEl = document.getElementById('display-calc-disponivel');
        if(disponivel < 0) {
            dispEl.classList.remove('text-teal-600');
            dispEl.classList.add('text-red-600');
        } else {
            dispEl.classList.remove('text-red-600');
            dispEl.classList.add('text-teal-600');
        }
    }

    function irParaPendencia(competencia, id) {
        pendingHighlightId = id;
        showView('conferencia');
        showToast(`Localizando pendência...`, 'success');
    }

    // --- 2. HELPERS DE AÇÃO E RENDERIZADORES ---

    function getActions(key, row, idIdx) {
        const id = row[idIdx]; 
        const safe = s => String(s).replace(/'/g,"\\'").replace(/"/g,"&quot;"); 
        let params = "{}";
        
        if(key==='IMPOSTO') params=`{id:'${id}', tipo:'${safe(row[1])}', descricao:'${safe(row[2])}', valor:'${safe(row[3])}', obs:'${safe(row[4])}'}`;
        
        if(key==='FOLHA') params=`{id:'${id}', tipo:'${safe(row[1])}', valorBruto:'${safe(row[2])}', valorDescontos:'${safe(row[3])}', obs:'${safe(row[5])}'}`;
        if(key==='DECIMO') params=`{id:'${id}', tipo:'${safe(row[1])}', valorBruto:'${safe(row[2])}', valorDescontos:'${safe(row[3])}', obs:'${safe(row[5])}'}`;
        
        if(key==='CONSIGNADOS') params=`{id:'${id}', tipo:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[3])}'}`;
        if(key==='OUTROS_BANCOS') params=`{id:'${id}', nome:'${safe(row[1])}', tipo:'${safe(row[2])}', banco:'${safe(row[3])}', valor:'${safe(row[4])}', obs:'${safe(row[5])}'}`;
        
        if(key==='RECORRENTES') params=`{id:'${id}', descricao:'${safe(row[1])}', tipo:'${safe(row[2])}', valor:'${safe(row[3])}', notaFiscal:'${safe(row[4])}', obs:'${safe(row[6])}'}`;
        
        if(key==='OUTROS_PGTOS') params=`{id:'${id}', descricao:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[4])}'}`;
        
        let modal = 'modal-folha'; 
        let action = 'adicionarFolha';
        
        if(key==='IMPOSTO') { modal='modal-imposto'; action='adicionarImpostoRenda'; }
        else if(key==='DECIMO') { modal='modal-decimo'; action='adicionarDecimo'; }
        else if(key==='CONSIGNADOS') { modal='modal-consignados'; action='adicionarConsignado'; }
        else if(key==='OUTROS_BANCOS') { modal='modal-outros'; action='adicionarOutrosBancos'; }
        else if(key==='RECORRENTES') { modal='modal-recorrentes'; action='adicionarRecorrente'; }
        else if(key==='OUTROS_PGTOS') { modal='modal-eventuais'; action='adicionarOutroPagamento'; }
        
        return `<button onclick="abrirModal('${modal}','${action}',${params})" class="text-blue-500 mr-2 hover:bg-blue-100 p-1 rounded transition"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('${key}','${id}')" class="text-red-400 hover:bg-red-100 p-1 rounded transition"><i class="fas fa-trash"></i></button>`;
    }

    // Renderers Padronizados
    function renderRowImposto(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-bold text-blue-900">${row[1]}</td><td class="p-3 text-blue-800">${row[2]}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[3])}</td><td class="p-3 text-xs text-blue-500">${row[4]}</td><td class="p-3 text-center">${getActions('IMPOSTO', row, 6)}</td></tr>`; }
    function renderRowFolha(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-medium text-gray-500">${formatCurrency(row[2])}</td><td class="p-3 text-right font-medium text-red-400 text-xs">-${formatCurrency(row[3])}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-500">${row[5]}</td><td class="p-3 text-center">${getActions('FOLHA', row, 8)}</td></tr>`; }
    function renderRowDecimo(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-medium text-gray-500">${formatCurrency(row[2])}</td><td class="p-3 text-right font-medium text-red-400 text-xs">-${formatCurrency(row[3])}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-500">${row[5]}</td><td class="p-3 text-center">${getActions('DECIMO', row, 8)}</td></tr>`; }
    function renderRowOutros(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-xs text-blue-500">${row[2]}</td><td class="p-3 text-blue-800">${row[3]}</td><td class="p-3 text-right font-bold text-orange-600">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-400">${row[5]}</td><td class="p-3 text-center">${getActions('OUTROS_BANCOS', row, 8)}</td></tr>`; }
    function renderRowConsig(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-bold text-purple-600">${formatCurrency(row[2])}</td><td class="p-3 text-xs text-blue-500">${row[3]}</td><td class="p-3 text-center">${getActions('CONSIGNADOS', row, 6)}</td></tr>`; }
    function renderRowRecorrente(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}<br><span class="text-xs text-gray-400">${row[2]}</span></td><td class="p-3 text-xs font-bold text-gray-500">${row[4] || '-'}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[3])}</td><td class="p-3 text-center">${getActions('RECORRENTES', row, 7)}</td></tr>`; }
    function renderRowEventual(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[2])}</td><td class="p-3 text-center">${getActions('OUTROS_PGTOS', row, 5)}</td></tr>`; }
    
    // NOVO: Renderer para Histórico de Margem
    function renderRowMargem(row) {
        const disponivel = parseValue(row[8]);
        const colorDisp = disponivel < 0 ? 'text-red-600' : 'text-teal-600';
        return `<tr class="border-b hover:bg-teal-50 border-teal-100">
            <td class="p-3 font-medium text-gray-800">${row[1]}</td>
            <td class="p-3 text-right text-gray-600">${formatCurrency(row[4])}</td>
            <td class="p-3 text-right text-gray-600 font-bold">${formatCurrency(row[6])}</td>
            <td class="p-3 text-right text-red-500 text-xs">${formatCurrency(row[7])}</td>
            <td class="p-3 text-right ${colorDisp} font-extrabold text-lg">${formatCurrency(row[8])}</td>
            <td class="p-3 text-center"><button onclick="excluir('MARGEM','${row[10]}')" class="text-red-400 hover:bg-red-100 p-1 rounded transition"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    }

    // --- 3. FETCH E LOGICA DE DADOS ---

    async function fetchData(action, params = '') {
        const cacheKey = `${action}_${currentCompetencia}_${params}`;
        if (CACHE[cacheKey]) { return CACHE[cacheKey]; }
        try {
            const res = await fetch(`${API_URL}?action=${action}&competencia=${currentCompetencia}&token=${authToken}&${params}`);
            const json = await res.json();
            if (json.status === 'success') { CACHE[cacheKey] = json; }
            return json;
        } catch(e) { console.log(e); return {status:'error'}; }
    }
    function invalidateCache() { CACHE = {}; }

    // --- 4. FUNÇÕES DE CARREGAMENTO ---

    function renderLista(json, tbodyId, emptyId, renderFn, sheetType) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';
        let sumBruto = 0, sumDesc = 0, sumLiq = 0;
        if(json.data && json.data.length > 0) {
            document.getElementById(emptyId).classList.add('hidden');
            json.data.forEach(r => {
                tbody.innerHTML += renderFn(r);
                if(sheetType === 'FOLHA' || sheetType === 'DECIMO') {
                    sumBruto += parseValue(r[2]); sumDesc += parseValue(r[3]); sumLiq += parseValue(r[4]);
                } else if (sheetType === 'OUTROS') sumLiq += parseValue(r[4]);
                else if (sheetType === 'CONSIGNADOS' || sheetType === 'EVENTUAIS') sumLiq += parseValue(r[2]);
                else if (sheetType === 'RECORRENTES' || sheetType === 'IMPOSTO') sumLiq += parseValue(r[3]);
            });
            updateFooter(sheetType, sumBruto, sumDesc, sumLiq);
        } else { 
            document.getElementById(emptyId).classList.remove('hidden'); 
            const footerId = getFooterId(sheetType);
            if(footerId) document.getElementById(footerId).classList.add('hidden');
        }
    }
    
    function getFooterId(type) {
        if(type === 'FOLHA') return 'foot-folha';
        if(type === 'DECIMO') return 'foot-decimo';
        if(type === 'OUTROS') return 'foot-outros';
        if(type === 'CONSIGNADOS') return 'foot-consignados';
        if(type === 'RECORRENTES') return 'foot-recorrentes';
        if(type === 'EVENTUAIS') return 'foot-eventuais';
        if(type === 'IMPOSTO') return 'foot-imposto';
        return null;
    }

    function updateFooter(type, bruto, desc, liq) {
        const fid = getFooterId(type);
        if(!fid) return;
        const foot = document.getElementById(fid);
        foot.classList.remove('hidden');
        if(type === 'FOLHA' || type === 'DECIMO') {
            document.getElementById(`total-${type.toLowerCase()}-bruto`).innerText = formatCurrency(bruto);
            document.getElementById(`total-${type.toLowerCase()}-desc`).innerText = '-' + formatCurrency(desc);
            document.getElementById(`total-${type.toLowerCase()}-liq`).innerText = formatCurrency(liq);
        } else {
            const el = document.getElementById(`total-${type.toLowerCase()}-val`);
            if(el) el.innerText = formatCurrency(liq);
        }
    }
    
    // Helper seguro para setar innerText sem erro de nulo
    function setElementText(id, value) {
        const el = document.getElementById(id);
        if(el) el.innerText = value;
    }

    async function carregarLista(sheet, tbodyId, emptyId, renderFn, force = false) {
        if(force) invalidateCache();
        const cacheKey = `getList_${currentCompetencia}_sheet=${sheet}`;
        let sheetType = '';
        if(sheet === 'FOLHA_PAGAMENTO') sheetType = 'FOLHA';
        else if(sheet === 'DECIMO_TERCEIRO') sheetType = 'DECIMO';
        else if(sheet === 'OUTROS_BANCOS') sheetType = 'OUTROS';
        else if(sheet === 'CONSIGNADOS') sheetType = 'CONSIGNADOS';
        else if(sheet === 'PAGAMENTOS_RECORRENTES') sheetType = 'RECORRENTES';
        else if(sheet === 'OUTROS_PAGAMENTOS') sheetType = 'EVENTUAIS';
        else if(sheet === 'IMPOSTO_RENDA') sheetType = 'IMPOSTO';
        else if(sheet === 'HISTORICO_MARGEM') sheetType = 'MARGEM'; 

        if (!force && CACHE[cacheKey]) { renderLista(CACHE[cacheKey], tbodyId, emptyId, renderFn, sheetType); return; }
        setLoading(true);
        const json = await fetchData('getList', `sheet=${sheet}`);
        renderLista(json, tbodyId, emptyId, renderFn, sheetType);
        setLoading(false);
    }

    function showView(view) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('tab-active'));
        document.getElementById(`view-${view}`).classList.remove('hidden-section');
        document.getElementById(`btn-${view}`).classList.add('tab-active');
        
        if(view === 'resumo') carregarResumo();
        else if(view === 'graficos') carregarHistorico();
        else if(view === 'conferencia') carregarConferencia();
        else if(view === 'margem') carregarMargem(); // Nova view
        else if(view === 'folha') carregarLista('FOLHA_PAGAMENTO', 'lista-folha', 'empty-folha', renderRowFolha);
        else if(view === 'imposto') carregarLista('IMPOSTO_RENDA', 'lista-imposto', 'empty-imposto', renderRowImposto);
        else if(view === 'outros') carregarLista('OUTROS_BANCOS', 'lista-outros', 'empty-outros', renderRowOutros);
        else if(view === 'consignados') carregarLista('CONSIGNADOS', 'lista-consignados', 'empty-consignados', renderRowConsig);
        else if(view === 'adm') { 
            carregarLista('PAGAMENTOS_RECORRENTES', 'lista-recorrentes', 'empty-recorrentes', renderRowRecorrente); 
            carregarLista('OUTROS_PAGAMENTOS', 'lista-eventuais', 'empty-eventuais', renderRowEventual); 
        }
        else if(view === 'pendencias') carregarPendencias();
        else if(view === 'decimo') carregarLista('DECIMO_TERCEIRO', 'lista-decimo', 'empty-decimo', renderRowDecimo);
        else if(view === 'guias') carregarGuias();
    }

    async function carregarMargem() {
        carregarLista('HISTORICO_MARGEM', 'lista-margem', 'empty-margem', renderRowMargem);
    }

    async function carregarResumo(force = false) {
        if(force) invalidateCache();
        const cacheKey = `getResumoMensal_${currentCompetencia}_`;
        if (!force && CACHE[cacheKey]) { renderResumo(CACHE[cacheKey]); return; }
        if(!force) setLoading(true);
        const json = await fetchData('getResumoMensal');
        renderResumo(json);
        setLoading(false);
    }
    
    function renderResumo(json) {
         if(json.status === 'success') {
            // Verificação de segurança para evitar erro em dados nulos
            const brutoNormal = json.folha.total_bruto_normal || 0;
            const brutoDecimo = json.folha.total_bruto_decimo || 0;
            const brutoTotal = brutoNormal + brutoDecimo;
            
            // Uso da função auxiliar setElementText para evitar erros de elemento nulo
            setElementText('dash-total-bruto', formatCurrency(brutoTotal));
            setElementText('dash-total-liquido', formatCurrency(json.folha.total_geral));
            setElementText('dash-total-bradesco', formatCurrency(json.bancos.bradesco));
            setElementText('dash-total-outros', formatCurrency(json.bancos.outros));
            setElementText('dash-total-imposto', formatCurrency(json.imposto.total));
            setElementText('dash-total-consig', formatCurrency(json.consignados.total));
            setElementText('dash-total-adm', formatCurrency(json.administrativo.total));
            setElementText('dash-recolhimento-pago', formatCurrency(json.recolhimento.pago));
            setElementText('dash-recolhimento-devido', formatCurrency(json.recolhimento.devido));
            setElementText('conf-folha', formatCurrency(json.folha.total_geral));
            setElementText('conf-outros', formatCurrency(json.bancos.outros));
            setElementText('conf-bradesco', formatCurrency(json.bancos.bradesco));
        }
    }

    async function carregarHistorico(force = false) {
        setLoading(true);
        const yearInput = document.getElementById('chartYearInput');
        const anoSelecionado = yearInput.value || new Date().getFullYear();
        const meses = [];
        for (let i = 1; i <= 12; i++) meses.push(`${String(i).padStart(2,'0')}/${anoSelecionado}`);

        const promises = meses.map(comp => 
            fetch(`${API_URL}?action=getResumoMensal&competencia=${comp}&token=${authToken}`)
            .then(r => r.json())
        );
        
        const resultados = await Promise.all(promises);
        const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        const dadosDespesa = [];
        const dadosReceita = [];
        const tabelaBody = document.getElementById('table-analise-body');
        tabelaBody.innerHTML = '';

        resultados.forEach((r, idx) => {
            if(r.status === 'success') {
                const folhaBruta = (r.folha.total_bruto_normal || 0) + (r.folha.total_bruto_decimo || 0);
                const outrasDesp = (r.administrativo.total || 0);
                const totalDespesa = folhaBruta + outrasDesp; 
                const repasse = r.recolhimento.pago || 0;
                const resultado = totalDespesa - repasse;
                const resCor = resultado > 0 ? 'text-red-600' : 'text-blue-600'; 
                const resSinal = resultado > 0 ? '+' : ''; 

                dadosDespesa.push(totalDespesa);
                dadosReceita.push(repasse);

                tabelaBody.innerHTML += `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                        <td class="px-4 py-3 font-medium text-gray-600">${labels[idx]}</td>
                        <td class="px-4 py-3 text-right text-gray-500">${formatCurrency(folhaBruta)}</td>
                        <td class="px-4 py-3 text-right text-gray-400 text-xs">${formatCurrency(outrasDesp)}</td>
                        <td class="px-4 py-3 text-right font-bold text-gray-700 bg-gray-50">${formatCurrency(totalDespesa)}</td>
                        <td class="px-4 py-3 text-right text-green-600">${formatCurrency(repasse)}</td>
                        <td class="px-4 py-3 text-right font-extrabold ${resCor}">${resSinal}${formatCurrency(resultado)}</td>
                    </tr>
                `;
            } else {
                dadosDespesa.push(0); dadosReceita.push(0);
                tabelaBody.innerHTML += `<tr><td colspan="6" class="px-4 py-3 text-center text-xs text-gray-400">Sem dados para ${labels[idx]}</td></tr>`;
            }
        });

        renderizarGraficoHistorico(labels, dadosDespesa, dadosReceita);
        setLoading(false);
    }

    function renderizarGraficoHistorico(labels, dataDespesa, dataReceita) {
        const ctx = document.getElementById('historicalChart').getContext('2d');
        if(financeChart) financeChart.destroy();

        financeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Despesas Totais (Bruto)', data: dataDespesa, backgroundColor: '#ef4444', borderRadius: 4 },
                    { label: 'Repasses (Guias)', data: dataReceita, backgroundColor: '#22c55e', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR', {compactDisplay:'short', notation:'compact'}) } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.dataset.label + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(ctx.parsed.y)
                        }
                    }
                }
            }
        });
    }

    // --- 6. FUNÇÕES DE DADOS ESPECÍFICOS ---

    async function carregarGuias() {
        setLoading(true); 
        const json = await fetchData('getGuiasDetalhadas');
        const container = document.getElementById('container-guias');
        const empty = document.getElementById('empty-guias');
        container.innerHTML = '';
        if(json.status === 'success' && json.data.length > 0) {
            empty.classList.add('hidden');
            json.data.forEach(g => {
                const pendente = g.totalDevido - g.totalPago;
                const statusColor = pendente <= 0.01 ? 'bg-green-100 border-green-500' : 'bg-white border-purple-200';
                const statusText = pendente <= 0.01 ? '<span class="text-green-600 font-bold">QUITADO</span>' : `<span class="text-red-600 font-bold">Resta: ${formatCurrency(pendente)}</span>`;
                let pgtosHtml = '';
                if(g.pagamentos && g.pagamentos.length > 0) {
                    pgtosHtml = `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500"><p class="font-bold mb-1">Histórico:</p>`;
                    g.pagamentos.forEach(p => { pgtosHtml += `<div class="flex justify-between"><span>${p.data.split('T')[0]} - ${p.obs}</span> <span>${formatCurrency(p.valor)}</span></div>`; });
                    pgtosHtml += `</div>`;
                }
                let detalhesValores = `Princ: ${formatCurrency(g.vPrincipal)} | 13º: ${formatCurrency(g.vDecimo)}`;
                if(g.tipo.includes('ENFERMAGEM')) detalhesValores = `Seg: ${formatCurrency(g.vSegurado)} | Patr: ${formatCurrency(g.vPatronal)}`;
                container.innerHTML += `<div class="rounded-lg border-l-4 shadow-sm p-4 ${statusColor}"><div class="flex justify-between items-start"><div><h3 class="font-bold text-gray-800 text-lg">${g.tipo}</h3><p class="text-xs text-gray-500 font-mono">${detalhesValores}</p><div class="mt-2 text-sm">Devido: <strong>${formatCurrency(g.totalDevido)}</strong> <span class="mx-2 text-gray-300">|</span> Pago: <strong>${formatCurrency(g.totalPago)}</strong></div></div><div class="text-right">${statusText}<div class="mt-2 flex gap-1 justify-end"><button onclick="abrirModalPagamento('${g.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow"><i class="fas fa-check"></i> Pagar</button><button onclick="editarGuia('${g.id}', '${g.tipo}', '${g.vPrincipal}', '${g.vDecimo}', '${g.vSegurado}', '${g.vPatronal}', '${g.obs}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('GUIAS', '${g.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-200"><i class="fas fa-trash"></i></button></div></div></div>${pgtosHtml}</div>`;
            });
        } else { empty.classList.remove('hidden'); }
        setLoading(false);
    }

    async function carregarConferencia(force = false) {
        if(force) invalidateCache();
        const cacheKey = `getConferencia_${currentCompetencia}_`;
        if (!force && CACHE[cacheKey]) { renderConferencia(CACHE[cacheKey]); return; }
        setLoading(true);
        const json = await fetchData('getConferencia');
        renderConferencia(json);
        setLoading(false);
    }

    function renderConferencia(json) {
        const container = document.getElementById('conferencia-container');
        const empty = document.getElementById('empty-conferencia');
        container.innerHTML = '';
        if(json.status === 'success' && json.data.length > 0) {
            empty.classList.add('hidden');
            const grupos = {};
            json.data.forEach(item => { if(!grupos[item.grupo]) grupos[item.grupo] = []; grupos[item.grupo].push(item); });
            for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                let rows = '';
                itens.forEach(item => {
                    const isPago = item.status === 'Pago';
                    const switchHtml = `<label class="switch"><input type="checkbox" ${isPago ? 'checked' : ''} onchange="togglePagamento('${item.id}', '${item.origem}', this)"><span class="slider"></span></label><span class="switch-label">${isPago ? 'PAGO' : 'PENDENTE'}</span>`;
                    
                    const compHtml = `<span class="inline-block bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-100 mt-1"><i class="far fa-calendar-alt mr-1"></i>${item.competencia}</span>`;
                    const rowClass = isPago 
                        ? 'bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300' 
                        : 'bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300';
                    const textClass = isPago ? 'text-gray-400 line-through' : 'text-gray-900';

                    rows += `<tr id="row-${item.id}" class="border-b last:border-0 ${rowClass}">
                        <td class="px-6 py-4 w-1/4">
                            <div class="text-xs font-bold uppercase text-gray-500">${item.origem}</div>
                            ${compHtml}
                        </td>
                        <td class="px-6 py-4 font-medium ${textClass} w-1/3">${item.descricao}</td>
                        <td class="px-6 py-4 text-right font-bold w-1/4">${formatCurrency(item.valor)}</td>
                        <td class="px-6 py-4 text-center flex items-center justify-center">${switchHtml}</td>
                    </tr>`;
                });
                container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-700">${nomeGrupo}</h3><span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">${itens.length}</span></div><table class="w-full text-sm text-left"><tbody class="divide-y divide-gray-100">${rows}</tbody></table></div>`;
            }
        } else { empty.classList.remove('hidden'); }

        if (pendingHighlightId) {
            const el = document.getElementById(`row-${pendingHighlightId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlight-row');
                setTimeout(() => { el.classList.remove('highlight-row'); }, 3000);
            }
            pendingHighlightId = null; 
        }
    }

    async function carregarPendencias(force=false) {
         if(force) invalidateCache();
         const cacheKey = `getPendencias_${currentCompetencia}_`; 
         if(!force && CACHE['getPendencias_']) { renderPendencias(CACHE['getPendencias_']); return; }
         setLoading(true);
         const json = await fetchData('getPendencias'); 
         CACHE['getPendencias_'] = json; 
         renderPendencias(json);
         setLoading(false);
    }

    function renderPendencias(json) {
        const container = document.getElementById('pendencias-container');
        const emptyDiv = document.getElementById('empty-pendencias');
        container.innerHTML = '';
        if(json.status === 'success' && json.data.length > 0) {
            emptyDiv.classList.add('hidden');
            const grupos = {};
            json.data.forEach(item => { const grp = item.grupo || 'Geral'; if(!grupos[grp]) grupos[grp] = []; grupos[grp].push(item); });
            for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                let rows = '';
                itens.forEach(row => {
                    let badgeClass = 'bg-red-100 text-red-600'; if(row.status === 'A Receber') badgeClass = 'bg-purple-100 text-purple-600';
                    rows += `<tr onclick="irParaPendencia('${row.competencia}', '${row.idOriginal}')" class="hover:bg-red-50 border-b border-red-100 last:border-0 cursor-pointer transition-colors" title="Clique para resolver em ${row.competencia}">
                        <td class="px-6 py-3 text-sm font-bold text-gray-700 w-1/6">${row.competencia}</td>
                        <td class="px-6 py-3 text-xs uppercase text-gray-500 w-1/6">${row.origem}</td>
                        <td class="px-6 py-3 text-sm text-gray-800 font-medium w-1/3">${row.descricao}</td>
                        <td class="px-6 py-3 text-right font-bold text-gray-800 w-1/6">${formatCurrency(row.valor)}</td>
                        <td class="px-6 py-3 text-center w-1/6"><span class="${badgeClass} font-bold text-xs px-2 py-1 rounded">${row.status}</span></td>
                    </tr>`;
                });
                container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-red-100 mb-6"><div class="bg-red-50 px-6 py-3 border-b border-red-100 flex justify-between items-center"><h3 class="font-bold text-red-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>${nomeGrupo}</h3><span class="bg-white text-red-600 text-xs px-2 py-1 rounded-full font-bold border border-red-200">${itens.length} itens</span></div><table class="w-full text-left"><tbody class="divide-y divide-red-50">${rows}</tbody></table></div>`;
            }
        } else { emptyDiv.classList.remove('hidden'); }
    }

    // --- 7. AÇÕES DE FORMULÁRIO E UI ---

    async function handleSubmit(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        data.action = data.id ? 'editarRegistro' : data.action_type;
        data.competencia = currentCompetencia;
        data.usuarioLog = currentUser;
        
        const modalEl = e.target.closest('div[id^="modal"]');
        if(modalEl) toggleModal(modalEl.id);
        
        invalidateCache();
        setLoading(true);
        try {
            const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)});
            const json = await res.json();
            showToast(json.status==='success'?'Salvo!':'Erro', json.status);
            
            if(data.action_type === 'adicionarCalculoMargem') {
                carregarMargem(); 
            } else if(data.action_type === 'adicionarGuiaObrigacao' || data.action_type === 'adicionarPagamentoGuia') { 
                carregarGuias(); 
            } else { 
                const activeBtn = document.querySelector('.nav-btn.tab-active');
                if(activeBtn && activeBtn.id !== 'btn-margem') activeBtn.click();
            }
        } catch(e) { showToast('Erro', 'error'); } finally { setLoading(false); }
    }

    async function togglePagamento(id, origem, checkbox) {
        checkbox.disabled = true;
        checkbox.classList.add('pointer-events-none');
        
        const novoStatus = checkbox.checked ? 'Pago' : 'Pendente';
        const label = checkbox.parentElement.nextElementSibling;
        label.innerText = novoStatus === 'Pago' ? 'PAGO' : 'PENDENTE';
        
        const tr = checkbox.closest('tr');
        const desc = tr.querySelector('td:nth-child(2)'); 
        
        if(novoStatus === 'Pago') {
            tr.className = "border-b last:border-0 bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300";
            desc.classList.add('text-gray-400', 'line-through');
            desc.classList.remove('text-gray-900');
        } else {
            tr.className = "border-b last:border-0 bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300";
            desc.classList.remove('text-gray-400', 'line-through');
            desc.classList.add('text-gray-900');
        }

        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'atualizarStatusPagamento', id, origem, novoStatus, usuarioLog: currentUser }) });
            const json = await res.json();
            
            if(json.status !== 'success') {
                throw new Error('Erro no servidor'); 
            }
            invalidateCache();
        } catch(e) { 
            checkbox.checked = !checkbox.checked; 
            label.innerText = checkbox.checked ? 'PAGO' : 'PENDENTE';
            if(!checkbox.checked) {
                tr.className = "border-b last:border-0 bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300";
                desc.classList.remove('text-gray-400', 'line-through');
                desc.classList.add('text-gray-900');
            } else {
                tr.className = "border-b last:border-0 bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300";
                desc.classList.add('text-gray-400', 'line-through');
                desc.classList.remove('text-gray-900');
            }
            showToast('Erro ao atualizar', 'error'); 
        } finally { 
            checkbox.disabled = false; 
            checkbox.classList.remove('pointer-events-none');
        }
    }

    async function carregarTiposParaSelect() {
        const res = await fetchData('getConfigGuias');
        const select = document.getElementById('select-tipo-guia');
        select.innerHTML = '';
        if(res.status === 'success') { res.data.forEach(t => { select.innerHTML += `<option value="${t.nome}">${t.nome}</option>`; }); }
    }
    
    function abrirModalPagamento(idGuia) { document.getElementById('input-id-guia-ref').value = idGuia; const hoje = new Date().toISOString().split('T')[0]; document.querySelector('#modal-pagamento-guia input[type="date"]').value = hoje; toggleModal('modal-pagamento-guia'); }
    
    function editarGuia(id, tipo, vPrinc, vDec, vSeg, vPatr, obs) { abrirModal('modal-guia', 'adicionarGuiaObrigacao', { id: id, tipo: tipo, valorPrincipal: vPrinc, valorDecimo: vDec, valorSegurado: vSeg, valorPatronal: vPatr, obs: obs }); const select = document.getElementById('select-tipo-guia'); select.value = tipo; select.dispatchEvent(new Event('change')); }
    
    function confirmarImportacao(sheetTarget) { openConfirm(`Copiar registros do mês anterior para ${currentCompetencia}?`, async () => { setLoading(true); try { const res = await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'importarMesAnterior', sheetTarget, competenciaAtual:currentCompetencia, usuarioLog:currentUser})}); const json = await res.json(); invalidateCache(); showToast(json.status==='success'?'Sucesso!':'Erro', json.status); if(json.status==='success') document.querySelector('.nav-btn.tab-active').click(); } catch(e) { showToast('Erro conexão', 'error'); } finally { setLoading(false); } }); }
    
    async function excluir(sheetKey, id) { openConfirm("Excluir este registro?", async () => { setLoading(true); await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'excluirRegistro', sheetName:sheetKey, id, competencia:currentCompetencia, usuarioLog:currentUser})}); invalidateCache(); showToast('Excluído', 'success'); if(sheetKey === 'GUIAS') carregarGuias(); else if(sheetKey === 'MARGEM') carregarMargem(); else document.querySelector('.nav-btn.tab-active').click(); setLoading(false); }); }
    
    function abrirModal(id, action, editData=null) {
        const m = document.getElementById(id);
        const f = m.querySelector('form');
        if (!f) return;
        f.reset();
        const actionInput = f.querySelector('[name="action_type"]');
        if (actionInput) actionInput.value = action;
        const idInput = f.querySelector('[name="id"]');
        if (idInput) idInput.value = "";
        const titleEl = m.querySelector('h3');
        if (titleEl) titleEl.innerText = titleEl.innerText.replace('Editar', 'Adicionar');
        if (editData) {
            if (idInput) idInput.value = editData.id;
            for (let k in editData) {
                const input = f.querySelector(`[name="${k}"]`);
                if (input) { input.value = k.includes('valor') ? formatCurrency(editData[k]) : editData[k]; }
            }
            
            if(id === 'modal-folha' || id === 'modal-decimo') calcularLiquidoVisual(f);

            if (titleEl) titleEl.innerText = titleEl.innerText.replace('Adicionar', 'Editar');
        }
        toggleModal(id);
    }

    // --- 8. INICIALIZAÇÃO ---
    window.onload = async function() {
        if(authToken) {
            if(currentUser && currentUser !== 'undefined') atualizarNomeUsuario(currentUser);
            try {
                const res = await fetch(`${API_URL}?action=verificarToken&token=${authToken}`);
                const json = await res.json();
                if(json.status === 'success') {
                    currentUser = json.usuario;
                    localStorage.setItem('rpps_user', currentUser);
                    iniciarSistema();
                } else { throw new Error('Token inválido'); }
            } catch(e) { console.log("Sessão inválida..."); logout(false); }
        } else { document.getElementById('login-screen').style.display = 'flex'; }
    };

    function iniciarSistema() {
        document.getElementById('login-screen').style.display = 'none';
        if(currentUser) atualizarNomeUsuario(currentUser);
        const d = new Date();
        const anoAtual = d.getFullYear();
        const v = `${anoAtual}-${String(d.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('inputCompetencia').value = v;
        document.getElementById('chartYearInput').value = anoAtual;
        mudarCompetencia(v);
        setupMoneyMask();
        document.getElementById('select-tipo-guia').addEventListener('change', function() {
            const isPiso = this.value.includes('ENFERMAGEM');
            document.getElementById('extra-fields-guia').classList.toggle('hidden', !isPiso);
        });
        preCarregarDados();
    }

    function atualizarNomeUsuario(nome) {
        document.getElementById('user-display').innerHTML = `<i class="fas fa-user-circle mr-2"></i>Olá, <strong>${nome}</strong>`;
    }
    
    function preCarregarDados() {
        const views = ['getResumoMensal', 'getConferencia', 'getPendencias', 'getGuiasDetalhadas'];
        views.forEach(v => fetchData(v));
        const lists = ['FOLHA_PAGAMENTO', 'DECIMO_TERCEIRO', 'OUTROS_BANCOS', 'CONSIGNADOS', 'PAGAMENTOS_RECORRENTES', 'IMPOSTO_RENDA'];
        lists.forEach(l => fetchData('getList', `sheet=${l}`));
    }

    function handleLogin(e) { 
        e.preventDefault();
        const form = e.target;
        const btn = form.querySelector('button');
        const msg = document.getElementById('login-msg');
        const inputUser = form.querySelector('input[name="usuario"]').value;
        
        btn.disabled = true; btn.innerText = 'Entrando...'; msg.classList.add('hidden');
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        data.action = 'login';
        
        fetch(API_URL, {
            method: 'POST', 
            redirect: 'follow',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
        })
        .then(res => res.text())
        .then(text => {
            let json;
            try { json = JSON.parse(text); } catch(err) { throw new Error("Resposta inválida"); }

            if(json.status === 'success') {
                localStorage.setItem('rpps_token', json.token);
                const usuarioFinal = json.usuario || inputUser; 
                localStorage.setItem('rpps_user', usuarioFinal);
                authToken = json.token; currentUser = usuarioFinal;
                iniciarSistema();
            } else { 
                msg.innerText = json.message || "Erro de conexão"; 
                msg.classList.remove('hidden'); 
            }
        })
        .catch(e => {
            msg.innerText = "Erro: " + e.message; 
            msg.classList.remove('hidden'); 
        })
        .finally(() => { btn.disabled = false; btn.innerText = 'ENTRAR'; });
    }

    function logout(confirmLogout = true) { 
        if(confirmLogout && !confirm("Sair do sistema?")) return; 
        localStorage.removeItem('rpps_token'); 
        localStorage.removeItem('rpps_user');
        location.reload(); 
    }

    function mudarCompetencia(v) {
        if(!v) return;
        currentCompetencia = `${v.split('-')[1]}/${v.split('-')[0]}`;
        document.querySelectorAll('.current-comp').forEach(e => e.innerText = currentCompetencia);
        document.getElementById('mobile-comp').innerText = currentCompetencia;
        CACHE = {}; 
        const activeBtn = document.querySelector('.nav-btn.tab-active');
        if(activeBtn) {
            if(activeBtn.id === 'btn-graficos') carregarHistorico();
            else if(activeBtn.id === 'btn-margem') carregarMargem(); // Recarrega se estiver na margem
            else activeBtn.click();
        }
        preCarregarDados();
    }
</script>