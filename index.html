<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão RPPS - Controle Financeiro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { background-color: #2563eb; color: white; }
        
        /* Loading Overlay */
        #loadingOverlay { z-index: 60; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none; }
        input[type="month"] { position: relative; }
        input[type="month"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(1); }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 70;
            left: 50%; top: 30px; transform: translateX(-50%); font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s, top 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }
        #toast.success { background-color: #10B981; }
        #toast.error { background-color: #EF4444; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10B981; }
        input:focus + .slider { box-shadow: 0 0 1px #10B981; }
        input:checked + .slider:before { transform: translateX(20px); }
        .switch-label { margin-left: 10px; font-size: 0.75rem; font-weight: bold; color: #6B7280; }
        input:checked ~ .switch-label { color: #10B981; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- TOAST -->
    <div id="toast"><i class="fas fa-check-circle mr-2"></i><span id="toast-msg">Mensagem</span></div>

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white shadow-lg flex flex-col z-20">
        <div class="p-6 bg-blue-800 text-white">
            <h1 class="text-lg font-bold mb-1"><i class="fas fa-university mr-2"></i>Gestão RPPS</h1>
            <p class="text-xs text-blue-200 mb-4">Controle Financeiro</p>
            
            <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Competência (Mês/Ano)</label>
            <div class="relative">
                <input type="month" id="inputCompetencia" onchange="mudarCompetencia(this.value)" 
                       class="w-full p-3 bg-blue-700 border border-blue-600 rounded text-white font-bold text-center focus:outline-none focus:border-white shadow-inner cursor-pointer hover:bg-blue-600 transition-colors">
            </div>
            <p class="text-[10px] text-center mt-2 text-blue-300">Selecione para mudar o mês</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <button onclick="showView('resumo')" id="btn-resumo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center tab-active">
                <i class="fas fa-chart-pie w-6"></i> Resumo
            </button>
            <button onclick="showView('conferencia')" id="btn-conferencia" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-50 text-green-800 font-bold transition-colors flex items-center">
                <i class="fas fa-check-double w-6"></i> Conferência Pagtos
            </button>
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('folha')" id="btn-folha" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-users w-6"></i> Folha Pagamento
            </button>
            <button onclick="showView('decimo')" id="btn-decimo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-gift w-6"></i> 13º Salário
            </button>
            <button onclick="showView('outros')" id="btn-outros" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-exchange-alt w-6"></i> Outros Bancos
            </button>
            <button onclick="showView('consignados')" id="btn-consignados" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-hand-holding-usd w-6"></i> Consignados
            </button>
            <button onclick="showView('adm')" id="btn-adm" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-invoice-dollar w-6"></i> Assessorias e Desp.
            </button>
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('pendencias')" id="btn-pendencias" class="nav-btn w-full text-left px-6 py-3 hover:bg-red-50 text-red-600 transition-colors flex items-center">
                <i class="fas fa-exclamation-circle w-6"></i> Pendências
            </button>
        </nav>
    </aside>

    <!-- ÁREA PRINCIPAL -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100 relative">
        
        <!-- LOADING OVERLAY -->
        <div id="loadingOverlay" class="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden backdrop-blur-sm">
            <div class="loader mb-4"></div>
            <p class="text-blue-600 font-bold text-lg animate-pulse">Processando...</p>
        </div>

        <!-- CABEÇALHO MOBILE -->
        <header class="bg-blue-800 text-white shadow-sm p-4 flex justify-between items-center md:hidden">
            <span class="font-bold text-lg">RPPS</span>
            <span id="mobile-comp" class="text-sm font-bold bg-blue-700 px-2 py-1 rounded">--/----</span>
        </header>

        <!-- CONTEÚDO SCROLLÁVEL -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainContent">
            
            <!-- VIEW: RESUMO -->
            <div id="view-resumo" class="view-section">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Resumo Financeiro</h2>
                        <p class="text-sm text-gray-500">Competência <span class="current-comp font-bold text-blue-600">--/----</span></p>
                    </div>
                    <button onclick="carregarResumo()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Obrigações (Folha+13º)</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-folha">R$ 0,00</h3>
                        <p class="text-xs text-gray-400 mt-1" id="dash-sub-folha">Carregando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Outros Bancos</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-outros">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Líquido Bradesco (Est.)</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-bradesco">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Consignados</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-consig">R$ 0,00</h3>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Conferência da Folha</h3>
                    <table class="w-full text-sm text-left">
                        <tbody class="divide-y divide-gray-100">
                            <tr><td class="px-4 py-3 font-medium">Total (Folha + 13º)</td><td class="px-4 py-3 text-right font-bold text-blue-600" id="conf-folha">R$ 0,00</td></tr>
                            <tr><td class="px-4 py-3">(-) Outros Bancos</td><td class="px-4 py-3 text-right text-red-500" id="conf-outros">R$ 0,00</td></tr>
                            <tr class="bg-green-50"><td class="px-4 py-3 font-bold">(=) Previsto Bradesco</td><td class="px-4 py-3 text-right font-bold text-green-700" id="conf-bradesco">R$ 0,00</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: CONFERÊNCIA -->
            <div id="view-conferencia" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-green-800"><i class="fas fa-check-double mr-2"></i>Conferência de Pagamentos</h2>
                    <button onclick="carregarConferencia()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-4 text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i> Marque o que já foi pago. Itens desligados constarão como <strong>Pendentes</strong>.
                </div>
                <div id="conferencia-container" class="space-y-6"></div>
                <div id="empty-conferencia" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhum lançamento neste mês.</div>
            </div>

            <!-- VIEW: FOLHA -->
            <div id="view-folha" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Folha de Pagamento</h2>
                    <button onclick="abrirModal('modal-folha', 'adicionarFolha')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-folha" class="divide-y divide-gray-100"></tbody></table>
                    <div id="empty-folha" class="p-8 text-center text-gray-500 hidden">Nenhum registro.</div>
                </div>
            </div>

            <!-- VIEW: 13º -->
            <div id="view-decimo" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-800">13º Salário</h2>
                    <button onclick="abrirModal('modal-decimo', 'adicionarDecimo')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-decimo" class="divide-y divide-blue-50"></tbody></table>
                    <div id="empty-decimo" class="p-8 text-center text-gray-500 hidden">Nenhum registro.</div>
                </div>
            </div>

            <!-- VIEW: OUTROS BANCOS -->
            <div id="view-outros" class="view-section hidden-section">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Outros Bancos</h2>
                    <div class="flex gap-2">
                        <button onclick="importarMesAnterior('OUTROS_BANCOS')" class="bg-gray-100 text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-200 text-sm shadow"><i class="fas fa-copy mr-2"></i>Copiar Lançamentos do Mês Anterior</button>
                        <button onclick="abrirModal('modal-outros', 'adicionarOutrosBancos')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Nome</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Banco</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-outros" class="divide-y divide-gray-100"></tbody></table>
                    <div id="empty-outros" class="p-8 text-center text-gray-500 hidden">Nenhum registro.</div>
                </div>
            </div>

            <!-- VIEW: CONSIGNADOS -->
            <div id="view-consignados" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Consignados</h2>
                    <button onclick="abrirModal('modal-consignados', 'adicionarConsignado')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-consignados" class="divide-y divide-gray-100"></tbody></table>
                    <div id="empty-consignados" class="p-8 text-center text-gray-500 hidden">Nenhum registro.</div>
                </div>
            </div>

            <!-- VIEW: ASSESSORIAS -->
            <div id="view-adm" class="view-section hidden-section">
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Assessorias Mensais</h3>
                        <div class="flex gap-2">
                             <button onclick="importarMesAnterior('PAGAMENTOS_RECORRENTES')" class="bg-gray-100 text-gray-700 border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-200 text-xs shadow"><i class="fas fa-copy mr-1"></i> Copiar Lançamentos do Mês Anterior</button>
                            <button onclick="abrirModal('modal-recorrentes', 'adicionarRecorrente')" class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs shadow"><i class="fas fa-plus mr-1"></i> Adicionar</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Descrição</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-recorrentes" class="divide-y divide-gray-100"></tbody></table>
                        <div id="empty-recorrentes" class="p-8 text-center text-gray-500 hidden">Nada lançado.</div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Outras Despesas (Eventuais)</h3>
                        <button onclick="abrirModal('modal-eventuais', 'adicionarOutroPagamento')" class="bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 text-xs shadow"><i class="fas fa-plus mr-1"></i> Adicionar</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Descrição</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">Ações</th></tr></thead><tbody id="lista-eventuais" class="divide-y divide-gray-100"></tbody></table>
                        <div id="empty-eventuais" class="p-8 text-center text-gray-500 hidden">Nada lançado.</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PENDÊNCIAS -->
            <div id="view-pendencias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-600">Pendências em Aberto</h2>
                    <button onclick="carregarPendencias()" class="text-sm text-gray-600 hover:text-gray-900"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Competência</th><th class="px-6 py-3">Origem</th><th class="px-6 py-3">Descrição</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">Status</th></tr></thead><tbody id="lista-pendencias" class="divide-y divide-gray-100"></tbody></table>
                    <div id="empty-pendencias" class="p-8 text-center text-gray-500 hidden">Nenhuma pendência.</div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS (SITUAÇÃO REMOVIDA) -->
    <div id="modal-folha" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Adicionar Folha</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarFolha"><input type="hidden" name="sheetKey" value="FOLHA"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo</label><select name="tipo" class="w-full border p-2 rounded" required><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor Total</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-folha')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-decimo" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-blue-600"><h3 class="font-bold text-lg mb-4 text-blue-800">Adicionar 13º</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarDecimo"><input type="hidden" name="sheetKey" value="DECIMO"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo</label><select name="tipo" class="w-full border p-2 rounded" required><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-decimo')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-outros" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Adicionar Outro Banco</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutrosBancos"><input type="hidden" name="sheetKey" value="OUTROS_BANCOS"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Nome</label><input name="nome" class="w-full border p-2 rounded" required></div><div class="grid grid-cols-2 gap-4"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo</label><select name="tipo" class="w-full border p-2 rounded"><option>Aposentado</option><option>Pensionista</option><option>Comissionado</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Banco</label><input name="banco" class="w-full border p-2 rounded" required></div></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-outros')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-consignados" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Adicionar Consignado</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarConsignado"><input type="hidden" name="sheetKey" value="CONSIGNADOS"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo/Banco</label><input name="tipo" class="w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-consignados')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-recorrentes" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Adicionar Assessoria</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarRecorrente"><input type="hidden" name="sheetKey" value="RECORRENTES"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Descrição</label><input name="descricao" class="w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo</label><select name="tipo" class="w-full border p-2 rounded"><option>Assessoria</option><option>Serviço</option><option>Outro</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-recorrentes')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-eventuais" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Adicionar Eventual</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutroPagamento"><input type="hidden" name="sheetKey" value="OUTROS_PGTOS"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Descrição</label><input name="descricao" class="w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-eventuais')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwt5wH_wT65wfXyaBc78YK4ZBHcCi7zFATSQRk6yytCTHFlqCLs1Gc7JSS395aYNUmR/exec";
        let currentCompetencia = "";

        window.onload = function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('inputCompetencia').value = `${yyyy}-${mm}`;
            mudarCompetencia(`${yyyy}-${mm}`);
            setupMoneyMask();
        };

        function mudarCompetencia(valYYYYMM) {
            if(!valYYYYMM) return;
            const [year, month] = valYYYYMM.split('-');
            currentCompetencia = `${month}/${year}`;
            document.querySelectorAll('.current-comp').forEach(el => el.innerText = currentCompetencia);
            document.getElementById('mobile-comp').innerText = currentCompetencia;
            const activeBtn = document.querySelector('.nav-btn.tab-active');
            if(activeBtn) activeBtn.click();
        }

        function showView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden-section');
            document.getElementById(`btn-${viewName}`).classList.add('tab-active');

            if (viewName === 'resumo') carregarResumo();
            if (viewName === 'conferencia') carregarConferencia();
            if (viewName === 'folha') carregarLista('FOLHA_PAGAMENTO', 'lista-folha', 'empty-folha', renderRowFolha);
            if (viewName === 'decimo') carregarLista('DECIMO_TERCEIRO', 'lista-decimo', 'empty-decimo', renderRowDecimo);
            if (viewName === 'outros') carregarLista('OUTROS_BANCOS', 'lista-outros', 'empty-outros', renderRowOutros);
            if (viewName === 'consignados') carregarLista('CONSIGNADOS', 'lista-consignados', 'empty-consignados', renderRowConsig);
            if (viewName === 'adm') {
                carregarLista('PAGAMENTOS_RECORRENTES', 'lista-recorrentes', 'empty-recorrentes', renderRowRecorrente);
                carregarLista('OUTROS_PAGAMENTOS', 'lista-eventuais', 'empty-eventuais', renderRowEventual);
            }
            if (viewName === 'pendencias') carregarPendencias();
        }

        // --- FUNÇÕES DE IMPORTAÇÃO E EXCLUSÃO ---
        async function importarMesAnterior(sheetTarget) {
            if(!confirm(`Confirma copiar todos os registros do mês anterior para ${currentCompetencia}?`)) return;
            setLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'importarMesAnterior', sheetTarget: sheetTarget, competenciaAtual: currentCompetencia })
                });
                const json = await response.json();
                if(json.status === 'success') { showToast('Sucesso: ' + json.message, 'success'); document.querySelector('.nav-btn.tab-active').click(); }
                else showToast('Erro: ' + json.message, 'error');
            } catch(e) { console.error(e); showToast('Erro de conexão.', 'error'); } finally { setLoading(false); }
        }

        async function excluir(sheetName, id) {
            if(!confirm("Tem certeza?")) return;
            setLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'excluirRegistro', sheetName: sheetName, id: id, competencia: currentCompetencia })
                });
                const json = await response.json();
                if(json.status === 'success') { showToast('Registro excluído!', 'success'); document.querySelector('.nav-btn.tab-active').click(); }
                else showToast("Erro: " + json.message, 'error');
            } catch(e) { console.error(e); showToast('Erro de comunicação', 'error'); } finally { setLoading(false); }
        }

        // --- ABRIR MODAL (ADICIONAR OU EDITAR) ---
        function abrirModal(modalId, actionType, editData = null) {
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            form.reset();
            form.querySelector('input[name="action_type"]').value = actionType;
            form.querySelector('input[name="id"]').value = "";
            const titleEl = modal.querySelector('h3');
            if (titleEl) titleEl.innerText = titleEl.innerText.replace('Editar', 'Adicionar');

            if (editData) {
                if (titleEl) titleEl.innerText = titleEl.innerText.replace('Adicionar', 'Editar');
                form.querySelector('input[name="id"]').value = editData.id;
                if(form.querySelector('[name="valor"]')) form.querySelector('[name="valor"]').value = formatCurrency(editData.valor);
                if(form.querySelector('[name="obs"]')) form.querySelector('[name="obs"]').value = editData.obs || '';
                if(form.querySelector('[name="tipo"]')) form.querySelector('[name="tipo"]').value = editData.tipo;
                if(form.querySelector('[name="nome"]')) form.querySelector('[name="nome"]').value = editData.nome;
                if(form.querySelector('[name="banco"]')) form.querySelector('[name="banco"]').value = editData.banco;
                if(form.querySelector('[name="descricao"]')) form.querySelector('[name="descricao"]').value = editData.descricao;
            }
            modal.classList.remove('hidden');
        }

        // --- SUBMISSÃO ---
        async function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (data.id) { data.action = 'editarRegistro'; } else { data.action = data.action_type; }
            data.competencia = currentCompetencia;
            const modalId = form.closest('div[id^="modal"]').id;
            toggleModal(modalId);
            setLoading(true);
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
                const json = await response.json();
                if(json.status === 'success') { showToast('Salvo com sucesso!', 'success'); document.querySelector('.nav-btn.tab-active').click(); }
                else showToast("Erro: " + json.message, 'error');
            } catch(e) { console.error(e); showToast("Erro de comunicação.", 'error'); } finally { setLoading(false); }
        }

        // --- RENDERIZADORES ---
        function getActionBtns(sheetKey, row, idIndex) {
            const id = row[idIndex];
            if(!id) return '';
            const safe = (str) => String(str).replace(/'/g, "\\'").replace(/"/g, "&quot;");
            let editParams = ``;
            let actionType = 'adicionarFolha'; let modalId = 'modal-folha';

            if (sheetKey === 'FOLHA') { modalId = 'modal-folha'; actionType = 'adicionarFolha'; editParams = `{id:'${id}', valor:'${safe(row[2])}', obs:'${safe(row[3])}', tipo:'${safe(row[1])}'}`; }
            if (sheetKey === 'DECIMO') { modalId = 'modal-decimo'; actionType = 'adicionarDecimo'; editParams = `{id:'${id}', valor:'${safe(row[2])}', obs:'${safe(row[3])}', tipo:'${safe(row[1])}'}`; }
            if (sheetKey === 'CONSIGNADOS') { modalId = 'modal-consignados'; actionType = 'adicionarConsignado'; editParams = `{id:'${id}', valor:'${safe(row[2])}', obs:'${safe(row[3])}', tipo:'${safe(row[1])}'}`; }
            if (sheetKey === 'OUTROS_BANCOS') { modalId = 'modal-outros'; actionType = 'adicionarOutrosBancos'; editParams = `{id:'${id}', nome:'${safe(row[1])}', tipo:'${safe(row[2])}', banco:'${safe(row[3])}', valor:'${safe(row[4])}', obs:'${safe(row[5])}'}`; }
            if (sheetKey === 'RECORRENTES') { modalId = 'modal-recorrentes'; actionType = 'adicionarRecorrente'; editParams = `{id:'${id}', descricao:'${safe(row[1])}', tipo:'${safe(row[2])}', valor:'${safe(row[3])}', obs:'${safe(row[5])}'}`; }
            if (sheetKey === 'OUTROS_PGTOS') { modalId = 'modal-eventuais'; actionType = 'adicionarOutroPagamento'; editParams = `{id:'${id}', descricao:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[4])}'}`; }

            return `<div class="flex justify-center gap-2"><button onclick="abrirModal('${modalId}', '${actionType}', ${editParams})" class="text-blue-500 hover:text-blue-700" title="Editar"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('${sheetKey}', '${id}')" class="text-red-400 hover:text-red-600" title="Excluir"><i class="fas fa-trash"></i></button></div>`;
        }

        function renderRowFolha(row) { return `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="px-6 py-4 font-medium">${row[1]}</td><td class="px-6 py-4 text-right font-bold text-blue-600">${formatCurrency(row[2])}</td><td class="px-6 py-4 text-xs">${row[3]}</td><td class="px-6 py-4 text-center">${getActionBtns('FOLHA', row, 6)}</td></tr>`; }
        function renderRowDecimo(row) { return `<tr class="hover:bg-blue-50 border-b border-blue-100 last:border-0"><td class="px-6 py-4 font-medium text-blue-900">${row[1]}</td><td class="px-6 py-4 text-right font-bold text-blue-700">${formatCurrency(row[2])}</td><td class="px-6 py-4 text-blue-500 text-xs">${row[3]}</td><td class="px-6 py-4 text-center">${getActionBtns('DECIMO', row, 6)}</td></tr>`; }
        function renderRowOutros(row) { return `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="px-6 py-4 font-medium">${row[1]}</td><td class="px-6 py-4 text-xs text-gray-500">${row[2]}</td><td class="px-6 py-4 text-sm">${row[3]}</td><td class="px-6 py-4 text-right font-bold text-orange-600">${formatCurrency(row[4])}</td><td class="px-6 py-4 text-gray-500 text-xs">${row[5]}</td><td class="px-6 py-4 text-center">${getActionBtns('OUTROS_BANCOS', row, 8)}</td></tr>`; }
        function renderRowConsig(row) { return `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="px-6 py-4 font-medium">${row[1]}</td><td class="px-6 py-4 text-right font-bold text-purple-600">${formatCurrency(row[2])}</td><td class="px-6 py-4 text-gray-500 text-xs">${row[3]}</td><td class="px-6 py-4 text-center">${getActionBtns('CONSIGNADOS', row, 6)}</td></tr>`; }
        function renderRowRecorrente(row) { return `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="px-6 py-4 font-medium">${row[1]}<br><span class="text-xs text-gray-400">${row[2]}</span></td><td class="px-6 py-4 text-right font-bold">${formatCurrency(row[3])}</td><td class="px-6 py-4 text-center">${getActionBtns('RECORRENTES', row, 6)}</td></tr>`; }
        function renderRowEventual(row) { return `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="px-6 py-4 font-medium">${row[1]}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(row[2])}</td><td class="px-6 py-4 text-center">${getActionBtns('OUTROS_PGTOS', row, 5)}</td></tr>`; }

        // --- CONFERÊNCIA AGRUPADA ---
        async function carregarConferencia() {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getConferencia&competencia=${currentCompetencia}`);
                const json = await response.json();
                const container = document.getElementById('conferencia-container');
                const empty = document.getElementById('empty-conferencia');
                container.innerHTML = '';
                if(json.status === 'success' && json.data.length > 0) {
                    empty.classList.add('hidden');
                    const grupos = {};
                    json.data.forEach(item => { if(!grupos[item.grupo]) grupos[item.grupo] = []; grupos[item.grupo].push(item); });
                    for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                        let rows = '';
                        itens.forEach(item => {
                            const isPago = item.status === 'Pago';
                            const switchHtml = `<label class="switch"><input type="checkbox" ${isPago ? 'checked' : ''} onchange="togglePagamento('${item.id}', '${item.origem}', this)"><span class="slider"></span></label><span class="switch-label">${isPago ? 'PAGO' : 'PENDENTE'}</span>`;
                            rows += `<tr class="hover:bg-gray-50 border-b last:border-0 ${isPago ? 'bg-green-50' : ''}"><td class="px-6 py-4 text-xs font-bold uppercase text-gray-500 w-1/4">${item.origem}</td><td class="px-6 py-4 font-medium ${isPago ? 'text-gray-400 line-through' : 'text-gray-900'} w-1/3">${item.descricao}</td><td class="px-6 py-4 text-right font-bold w-1/4">${formatCurrency(item.valor)}</td><td class="px-6 py-4 text-center flex items-center justify-center">${switchHtml}</td></tr>`;
                        });
                        container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-700">${nomeGrupo}</h3><span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">${itens.length}</span></div><table class="w-full text-sm text-left"><tbody class="divide-y divide-gray-100">${rows}</tbody></table></div>`;
                    }
                } else { empty.classList.remove('hidden'); }
            } catch(e) { console.error(e); showToast('Erro ao carregar lista', 'error'); } finally { setLoading(false); }
        }

        async function togglePagamento(id, origem, checkbox) {
            checkbox.disabled = true;
            const novoStatus = checkbox.checked ? 'Pago' : 'Pendente';
            const label = checkbox.parentElement.nextElementSibling;
            label.innerText = novoStatus === 'Pago' ? 'PAGO' : 'PENDENTE';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'atualizarStatusPagamento', id, origem, novoStatus }) });
                const json = await response.json();
                if(json.status !== 'success') { checkbox.checked = !checkbox.checked; showToast('Erro ao atualizar!', 'error'); }
                else {
                    const tr = checkbox.closest('tr');
                    const desc = tr.querySelector('td:nth-child(2)');
                    if(novoStatus === 'Pago') { tr.classList.add('bg-green-50'); desc.classList.add('text-gray-400', 'line-through'); desc.classList.remove('text-gray-900'); }
                    else { tr.classList.remove('bg-green-50'); desc.classList.remove('text-gray-400', 'line-through'); desc.classList.add('text-gray-900'); }
                }
            } catch(e) { checkbox.checked = !checkbox.checked; showToast('Erro de rede', 'error'); } finally { checkbox.disabled = false; }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.className = type === 'success' ? 'success' : 'error';
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function setLoading(active) { document.getElementById('loadingOverlay').classList.toggle('hidden', !active); }
        function formatCurrency(val) { return parseFloat(val || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function setupMoneyMask() { document.querySelectorAll('.money-mask').forEach(input => { input.addEventListener('input', e => { let v = e.target.value.replace(/\D/g, ""); v = (v/100).toFixed(2) + ""; v = v.replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); e.target.value = "R$ " + v; }); }); }
        
        async function carregarResumo() {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getResumoMensal&competencia=${currentCompetencia}`);
                const json = await response.json();
                if(json.status === 'success') {
                    document.getElementById('dash-total-folha').innerText = formatCurrency(json.folha.total_geral);
                    document.getElementById('dash-sub-folha').innerText = `Normal: ${formatCurrency(json.folha.total_normal)} | 13º: ${formatCurrency(json.folha.total_decimo)}`;
                    document.getElementById('dash-total-outros').innerText = formatCurrency(json.bancos.outros_bancos);
                    document.getElementById('dash-total-bradesco').innerText = formatCurrency(json.bancos.bradesco_estimado);
                    document.getElementById('dash-total-consig').innerText = formatCurrency(json.consignados.total);
                    document.getElementById('conf-folha').innerText = formatCurrency(json.folha.total_geral);
                    document.getElementById('conf-outros').innerText = formatCurrency(json.bancos.outros_bancos);
                    document.getElementById('conf-bradesco').innerText = formatCurrency(json.bancos.bradesco_estimado);
                }
            } catch (e) { console.error(e); } finally { setLoading(false); }
        }
        
        async function carregarLista(sheetName, tbodyId, emptyId, renderFn) {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getList&sheet=${sheetName}&competencia=${currentCompetencia}`);
                const json = await response.json();
                const tbody = document.getElementById(tbodyId);
                const empty = document.getElementById(emptyId);
                tbody.innerHTML = '';
                if(json.status === 'success' && json.data.length > 0) {
                    empty.classList.add('hidden');
                    json.data.forEach(row => tbody.innerHTML += renderFn(row));
                } else { empty.classList.remove('hidden'); }
            } catch(e) { console.error(e); } finally { setLoading(false); }
        }

        async function carregarPendencias() {
             setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getPendencias`);
                const json = await response.json();
                const tbody = document.getElementById('lista-pendencias');
                const emptyDiv = document.getElementById('empty-pendencias');
                tbody.innerHTML = '';
                if(json.status === 'success' && json.data.length > 0) {
                    emptyDiv.classList.add('hidden');
                    json.data.forEach(row => {
                        tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-bold text-gray-700">${row[0]}</td><td class="px-6 py-4"><span class="bg-gray-200 text-gray-700 py-1 px-2 rounded text-xs">${row[1]}</span></td><td class="px-6 py-4">${row[2]}</td><td class="px-6 py-4 text-right font-medium">${formatCurrency(row[3])}</td><td class="px-6 py-4 text-center"><span class="text-red-600 font-bold text-xs bg-red-100 px-2 py-1 rounded">PENDENTE</span></td></tr>`;
                    });
                } else { emptyDiv.classList.remove('hidden'); }
            } catch(e) { console.error(e); } finally { setLoading(false); }
        }
    </script>
</body>
</html>
