<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o RPPS - Controle Financeiro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js (Gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { background-color: #2563eb; color: white; }
        
        /* Loading Overlay */
        #loadingOverlay { z-index: 60; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none; }
        input[type="month"] { position: relative; }
        input[type="month"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(1); }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 80;
            left: 50%; top: 30px; transform: translateX(-50%); font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s, top 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }
        #toast.success { background-color: #10B981; }
        #toast.error { background-color: #EF4444; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10B981; }
        input:focus + .slider { box-shadow: 0 0 1px #10B981; }
        input:checked + .slider:before { transform: translateX(20px); }
        .switch-label { margin-left: 10px; font-size: 0.75rem; font-weight: bold; color: #6B7280; }
        input:checked ~ .switch-label { color: #10B981; }

        /* Modal Custom Confirm */
        #modal-confirm { z-index: 70; }
        
        /* Login Screen */
        #login-screen { z-index: 100; position: fixed; inset: 0; background-color: #1e3a8a; display: flex; align-items: center; justify-content: center; }

        /* Anima√ß√£o de Destaque para Pend√™ncia */
        @keyframes highlight-yellow {
            0% { background-color: #fef08a; transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            50% { background-color: #fef08a; transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); box-shadow: none; }
        }
        .highlight-row {
            animation: highlight-yellow 3s ease-out forwards;
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fas fa-university text-blue-800 text-5xl mb-2"></i>
                <h2 class="text-2xl font-bold text-gray-800">Gest√£o RPPS</h2>
                <p class="text-gray-500 text-sm">Acesso Restrito</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Usu√°rio</label>
                    <input type="text" name="usuario" class="w-full p-3 border rounded bg-gray-50 focus:border-blue-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Senha</label>
                    <input type="password" name="senha" class="w-full p-3 border rounded bg-gray-50 focus:border-blue-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-blue-800 text-white font-bold py-3 rounded hover:bg-blue-900 transition duration-200">ENTRAR</button>
            </form>
            <div id="login-msg" class="mt-4 text-center text-red-600 text-xs font-bold hidden border border-red-200 bg-red-50 p-2 rounded"></div>
            <p class="text-xs text-center text-gray-400 mt-4">V1.50 - M√≥dulo Margem</p>
        </div>
    </div>

    <!-- TOAST DE NOTIFICA√á√ÉO -->
    <div id="toast"><i class="fas fa-check-circle mr-2"></i><span id="toast-msg">Mensagem</span></div>
    
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="loader mb-4"></div>
        <p class="text-blue-600 font-bold text-lg animate-pulse">Processando...</p>
    </div>

    <!-- MODAL CONFIRMA√á√ÉO PERSONALIZADO -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border-t-4 border-blue-600">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i class="fas fa-question text-blue-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">Confirma√ß√£o</h3>
                <p class="text-sm text-gray-500 mb-6" id="confirm-msg">Tem certeza?</p>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium transition">Cancelar</button>
                <button onclick="closeConfirm(true)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white shadow-lg flex flex-col z-20">
        <div class="p-6 bg-blue-800 text-white">
            <div class="flex justify-between items-start mb-2">
                <h1 class="text-lg font-bold"><i class="fas fa-university mr-2"></i>Gest√£o RPPS</h1>
                <button onclick="logout()" class="text-xs text-blue-200 hover:text-white" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="flex justify-between items-center mb-4">
                <p class="text-xs text-blue-200 truncate" id="user-display">...</p>
                <button onclick="abrirModal('modal-novo-usuario', 'adicionarUsuario')" class="text-xs text-blue-300 hover:text-white" title="Novo Usu√°rio"><i class="fas fa-user-plus"></i></button>
            </div>
            <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Compet√™ncia (M√™s/Ano)</label>
            <div class="relative">
                <input type="month" id="inputCompetencia" onchange="mudarCompetencia(this.value)" 
                       class="w-full p-3 bg-blue-700 border border-blue-600 rounded text-white font-bold text-center focus:outline-none focus:border-white shadow-inner cursor-pointer hover:bg-blue-600 transition-colors">
            </div>
            <p class="text-[10px] text-center mt-2 text-blue-300">Selecione para mudar o m√™s</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <button onclick="showView('resumo')" id="btn-resumo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center tab-active">
                <i class="fas fa-chart-pie w-6"></i> Resumo
            </button>
            <button onclick="showView('graficos')" id="btn-graficos" class="nav-btn w-full text-left px-6 py-3 hover:bg-indigo-50 text-indigo-800 font-bold transition-colors flex items-center">
                <i class="fas fa-chart-bar w-6"></i> An√°lise Gr√°fica
            </button>
            
            <!-- NOVO BOT√ÉO MARGEM -->
            <button onclick="showView('margem')" id="btn-margem" class="nav-btn w-full text-left px-6 py-3 hover:bg-teal-50 text-teal-800 font-bold transition-colors flex items-center">
                <i class="fas fa-calculator w-6"></i> Calculadora Margem
            </button>

            <button onclick="showView('conferencia')" id="btn-conferencia" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-50 text-green-800 font-bold transition-colors flex items-center">
                <i class="fas fa-check-double w-6"></i> Confer√™ncia Pagtos
            </button>
            
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('pendencias')" id="btn-pendencias" class="nav-btn w-full text-left px-6 py-3 bg-red-50 text-red-700 font-bold border-l-4 border-red-500 hover:bg-red-100 transition-colors flex items-center">
                <i class="fas fa-exclamation-circle w-6"></i> Pend√™ncias
            </button>
            <button onclick="showView('guias')" id="btn-guias" class="nav-btn w-full text-left px-6 py-3 hover:bg-purple-50 text-purple-800 font-medium transition-colors flex items-center">
                <i class="fas fa-landmark w-6"></i> Recolhimento Guias
            </button>

            <!-- CADASTROS -->
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('folha')" id="btn-folha" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-users w-6"></i> Folha Pagamento
            </button>
            <button onclick="showView('decimo')" id="btn-decimo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-gift w-6"></i> 13¬∫ Sal√°rio
            </button>
            <button onclick="showView('outros')" id="btn-outros" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-exchange-alt w-6"></i> PGMT Outros Bancos
            </button>
            <button onclick="showView('consignados')" id="btn-consignados" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-hand-holding-usd w-6"></i> Consignados
            </button>
            <button onclick="showView('adm')" id="btn-adm" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-contract w-6"></i> Assessorias e Desp.
            </button>
            
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('imposto')" id="btn-imposto" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-invoice-dollar w-6"></i> Imposto de Renda
            </button>
        </nav>
    </aside>

    <!-- √ÅREA PRINCIPAL -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100 relative">
        <header class="bg-blue-800 text-white shadow-sm p-4 flex justify-between items-center md:hidden">
            <span class="font-bold text-lg">RPPS</span>
            <span id="mobile-comp" class="text-sm font-bold bg-blue-700 px-2 py-1 rounded">--/----</span>
        </header>

        <!-- CONTE√öDO SCROLL√ÅVEL -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainContent">
            
            <!-- VIEW: RESUMO -->
            <div id="view-resumo" class="view-section">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-sm text-gray-500">Compet√™ncia <span class="current-comp font-bold text-blue-600">--/----</span></p>
                    </div>
                    <button onclick="carregarResumo(true)" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                
                <!-- GRID DE CARDS -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Folha Bruta (Total) - AZUL ESCURO -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-800 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fas fa-coins text-6xl text-blue-800"></i></div>
                        <p class="text-sm text-gray-500 uppercase font-bold tracking-wide">Folha Bruta (Total)</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-bruto">R$ 0,00</h3>
                        <div class="mt-2 text-xs text-gray-400 font-semibold bg-gray-50 p-1 rounded inline-block">
                            <i class="fas fa-plus mr-1"></i> Proventos Folha + 13¬∫
                        </div>
                    </div>

                    <!-- Folha L√≠quida - AZUL CLARO -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fas fa-filter text-6xl text-blue-500"></i></div>
                        <p class="text-sm text-gray-500 uppercase font-bold tracking-wide">Folha L√≠quida</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-liquido">R$ 0,00</h3>
                        <div class="mt-2 text-xs text-gray-400 font-semibold bg-gray-50 p-1 rounded inline-block">
                            <i class="fas fa-calculator mr-1"></i> Folha Bruta - Descontos
                        </div>
                    </div>

                    <!-- L√≠quido Bradesco - VERDE -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 relative">
                        <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fas fa-university text-6xl text-green-500"></i></div>
                        <p class="text-sm text-gray-500 uppercase font-bold tracking-wide">L√≠quido Bradesco (Est.)</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-bradesco">R$ 0,00</h3>
                        <div class="mt-2 text-xs text-gray-400 font-semibold bg-gray-50 p-1 rounded inline-block">
                            <i class="fas fa-minus mr-1"></i> Folha L√≠quida - Outros Bancos
                        </div>
                    </div>

                    <!-- Linha 2 -->
                    <!-- Outros Bancos -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">PGMT Outros Bancos</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-outros">R$ 0,00</h3>
                    </div>

                    <!-- Consignados -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Consignados</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-consig">R$ 0,00</h3>
                    </div>

                    <!-- Assessorias -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                        <p class="text-xs text-gray-500 uppercase font-bold">Assessorias e Desp.</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-adm">R$ 0,00</h3>
                    </div>

                    <!-- Linha 3 -->
                    <!-- Imposto de Renda -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gray-600">
                        <p class="text-xs text-gray-500 uppercase font-bold">Imposto de Renda</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-imposto">R$ 0,00</h3>
                    </div>

                    <!-- Recolhimento Guias -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-800">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Recolhimento Guias</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-recolhimento-pago">R$ 0,00</h3>
                                <p class="text-xs text-gray-400 mt-1">De: <span id="dash-recolhimento-devido">R$ 0,00</span> (Devido)</p>
                            </div>
                            <div class="text-purple-800"><i class="fas fa-landmark text-2xl"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Confer√™ncia -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Confer√™ncia da Folha</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <tbody class="divide-y divide-gray-100">
                                <tr>
                                    <td class="px-4 py-3 font-medium">Total (Folha + 13¬∫)</td>
                                    <td class="px-4 py-3 text-right font-bold text-blue-600" id="conf-folha">R$ 0,00</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">(-) Outros Bancos</td>
                                    <td class="px-4 py-3 text-right text-red-500" id="conf-outros">R$ 0,00</td>
                                </tr>
                                <tr class="bg-green-50">
                                    <td class="px-4 py-3 font-bold">(=) Previsto Bradesco</td>
                                    <td class="px-4 py-3 text-right font-bold text-green-700" id="conf-bradesco">R$ 0,00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: GR√ÅFICOS E TABELA ANAL√çTICA -->
            <div id="view-graficos" class="view-section hidden-section">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-indigo-800"><i class="fas fa-chart-bar mr-2"></i>An√°lise Financeira</h2>
                    <div class="flex items-center gap-2 bg-white p-2 rounded shadow-sm">
                        <label class="text-sm font-bold text-gray-600">Ano:</label>
                        <input type="number" id="chartYearInput" class="border border-gray-300 rounded px-2 py-1 w-20 text-center font-bold text-indigo-700" min="2020" max="2030" onchange="carregarHistorico(true)">
                        <button onclick="carregarHistorico(true)" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded ml-2" title="Atualizar Gr√°fico"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                
                <!-- Gr√°fico -->
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600 mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">Evolu√ß√£o de Despesas vs Repasses (Jan - Dez)</h3>
                    <div class="w-full h-72 relative">
                        <canvas id="historicalChart"></canvas>
                    </div>
                </div>

                <!-- Tabela de Detalhamento Financeiro -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-gray-100 p-4 border-b border-gray-200">
                        <h3 class="font-bold text-gray-800">Detalhamento do Resultado Financeiro</h3>
                        <p class="text-xs text-gray-500 mt-1">C√°lculo: (Folha Bruta + 13¬∫ + Assessorias + Despesas) - Repasse</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-700 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-4 py-3">M√™s</th>
                                    <th class="px-4 py-3 text-right text-blue-700">Folha Bruta (+13¬∫)</th>
                                    <th class="px-4 py-3 text-right text-orange-600">Adm/Desp.</th>
                                    <th class="px-4 py-3 text-right bg-gray-100 font-bold">Total Despesas</th>
                                    <th class="px-4 py-3 text-right text-green-700">Repasse (Guias)</th>
                                    <th class="px-4 py-3 text-right font-extrabold">Resultado</th>
                                </tr>
                            </thead>
                            <tbody id="table-analise-body" class="divide-y divide-gray-100">
                                <!-- Linhas geradas via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: MARGEM CONSIGN√ÅVEL (NOVA) -->
            <div id="view-margem" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-teal-800"><i class="fas fa-calculator mr-2"></i>Calculadora de Margem</h2>
                    <p class="text-sm text-gray-500">Simule a margem dispon√≠vel para servidores</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Calculadora -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-teal-500">
                        <form onsubmit="handleSubmit(event)" oninput="calcularMargemVisual(this)">
                            <input type="hidden" name="action_type" value="adicionarCalculoMargem">
                            <input type="hidden" name="sheetKey" value="MARGEM">
                            
                            <!-- Campos Escondidos para Envio -->
                            <input type="hidden" name="liquido">
                            <input type="hidden" name="margemPermitida">
                            <input type="hidden" name="disponivel">

                            <div class="mb-4">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Nome do Servidor</label>
                                <input name="nome" class="w-full p-2 border rounded" placeholder="Ex: Jo√£o da Silva" required>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Renda Bruta</label>
                                    <input name="bruto" class="money-mask w-full p-2 border rounded bg-blue-50 border-blue-200 text-blue-800 font-bold" placeholder="R$ 0,00" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Desc. Obrigat√≥rios</label>
                                    <input name="descontos" class="money-mask w-full p-2 border rounded bg-red-50 border-red-200 text-red-800 font-bold" placeholder="R$ 0,00" required>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">% Margem</label>
                                    <input name="porcentagem" type="number" class="w-full p-2 border rounded text-center" value="35" min="1" max="100">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Parcelas J√° Contratadas</label>
                                    <input name="usoAtual" class="money-mask w-full p-2 border rounded" placeholder="R$ 0,00">
                                </div>
                            </div>

                            <!-- Resultados Visuais -->
                            <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-6">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Renda L√≠quida:</span>
                                    <span class="font-bold text-gray-800" id="display-calc-liquido">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Margem Permitida (35%):</span>
                                    <span class="font-bold text-blue-600" id="display-calc-permitida">R$ 0,00</span>
                                </div>
                                <div class="border-t border-gray-200 my-2"></div>
                                <div class="flex justify-between text-lg">
                                    <span class="font-bold text-teal-800">Margem Dispon√≠vel:</span>
                                    <span class="font-bold text-teal-600" id="display-calc-disponivel">R$ 0,00</span>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 rounded hover:bg-teal-700 shadow-lg transition">
                                <i class="fas fa-save mr-2"></i> Salvar Simula√ß√£o
                            </button>
                        </form>
                    </div>

                    <!-- Explica√ß√£o -->
                    <div class="bg-teal-50 p-6 rounded-xl border border-teal-100 h-fit">
                        <h3 class="font-bold text-teal-800 mb-4"><i class="fas fa-info-circle mr-2"></i>Como funciona o c√°lculo?</h3>
                        <ul class="space-y-3 text-sm text-teal-900">
                            <li><strong>1. Renda L√≠quida:</strong><br>Sal√°rio Bruto (-) Descontos Obrigat√≥rios (INSS, IRRF, Pens√£o).</li>
                            <li><strong>2. Margem Permitida:</strong><br>35% da Renda L√≠quida (ou a % que voc√™ definir).</li>
                            <li><strong>3. Margem Dispon√≠vel:</strong><br>Margem Permitida (-) Soma das parcelas de empr√©stimos que j√° est√£o descontando em folha.</li>
                        </ul>
                    </div>
                </div>

                <!-- Tabela de Hist√≥rico -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-100 p-4 border-b border-gray-200 font-bold text-gray-700">Hist√≥rico de Simula√ß√µes (M√™s Atual)</div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Servidor</th>
                                <th class="px-6 py-3 text-right">L√≠quido</th>
                                <th class="px-6 py-3 text-right">Margem Total</th>
                                <th class="px-6 py-3 text-right text-red-500">Em Uso</th>
                                <th class="px-6 py-3 text-right text-teal-600 font-bold">Dispon√≠vel</th>
                                <th class="px-6 py-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-margem" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-margem" class="p-8 text-center text-gray-500 hidden">Nenhuma simula√ß√£o salva neste m√™s.</div>
                </div>
            </div>

            <!-- VIEW: CONFER√äNCIA PAGAMENTOS (ATUALIZADO) -->
            <div id="view-conferencia" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-green-800"><i class="fas fa-check-double mr-2"></i>Confer√™ncia de Pagamentos</h2>
                    <button onclick="carregarConferencia(true)" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-4 text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i> Marque o que j√° foi pago. Itens n√£o pagos deste m√™s aparecer√£o automaticamente no pr√≥ximo.
                </div>
                <div id="conferencia-container" class="space-y-6"></div>
                <div id="empty-conferencia" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhum lan√ßamento neste m√™s.</div>
            </div>

            <!-- VIEW: PEND√äNCIAS ORGANIZADA -->
            <div id="view-pendencias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>Pend√™ncias em Aberto</h2>
                    <button onclick="carregarPendencias(true)" class="text-sm text-gray-600 hover:text-gray-900"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                
                <div id="pendencias-container" class="space-y-6">
                    <!-- JS vai inserir os grupos aqui -->
                </div>
                <div id="empty-pendencias" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhuma pend√™ncia encontrada! üéâ</div>
            </div>

            <!-- VIEW: RECOLHIMENTO GUIAS -->
            <div id="view-guias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-purple-800"><i class="fas fa-landmark mr-2"></i>Recolhimento de Guias</h2>
                        <p class="text-xs text-gray-500">Controle de repasses da Prefeitura</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="abrirModal('modal-config-guia', 'adicionarTipoGuia')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm"><i class="fas fa-cog"></i> Configurar Tipos</button>
                        <button onclick="carregarTiposParaSelect(); abrirModal('modal-guia', 'adicionarGuiaObrigacao')" class="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700"><i class="fas fa-plus"></i> Nova Guia</button>
                    </div>
                </div>
                
                <div id="container-guias" class="space-y-6">
                    <!-- Cards de Guias ser√£o inseridos aqui via JS -->
                </div>
                <div id="empty-guias" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhuma guia lan√ßada nesta compet√™ncia.</div>
            </div>

            <!-- VIEW: IMPOSTO DE RENDA (PADRONIZADO) -->
            <div id="view-imposto" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-900">Imposto de Renda (Retido)</h2>
                    <button onclick="abrirModal('modal-imposto', 'adicionarImpostoRenda')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>Lan√ßar IR</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-blue-50 text-blue-700 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Origem</th>
                                <th class="px-6 py-3">Descri√ß√£o</th>
                                <th class="px-6 py-3 text-right">Valor</th>
                                <th class="px-6 py-3">Obs</th>
                                <th class="px-6 py-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-imposto" class="divide-y divide-blue-50"></tbody>
                        <tfoot id="foot-imposto" class="bg-gray-100 font-bold text-gray-700 hidden">
                            <tr>
                                <td colspan="2" class="px-6 py-3 text-right">TOTAL:</td>
                                <td class="px-6 py-3 text-right" id="total-imposto-val"></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="empty-imposto" class="p-8 text-center text-gray-500 hidden">Nenhum lan√ßamento.</div>
                </div>
            </div>

            <!-- DEMAIS VIEWS (CADASTROS - PADRONIZADOS E COM BRUTO/LIQUIDO) -->
            <div id="view-folha" class="view-section hidden-section">
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold text-blue-900">Folha Pagamento</h2><button onclick="abrirModal('modal-folha', 'adicionarFolha')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div>
                <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-blue-50 text-blue-700 uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">Tipo</th><th class="px-4 py-3 text-right">Bruto</th><th class="px-4 py-3 text-right text-red-500">Desc.</th><th class="px-4 py-3 text-right">L√≠quido</th><th class="px-4 py-3">Obs</th><th class="px-4 py-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-folha" class="divide-y divide-blue-50"></tbody>
                        <tfoot id="foot-folha" class="bg-gray-100 font-bold text-gray-700 hidden">
                            <tr>
                                <td class="px-4 py-3 text-right">TOTAL:</td>
                                <td class="px-4 py-3 text-right" id="total-folha-bruto"></td>
                                <td class="px-4 py-3 text-right text-red-500" id="total-folha-desc"></td>
                                <td class="px-4 py-3 text-right text-blue-700" id="total-folha-liq"></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="empty-folha" class="p-4 text-center hidden">Vazio</div>
                </div>
            </div>
            
            <div id="view-decimo" class="view-section hidden-section">
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold text-blue-900">13¬∫ Sal√°rio</h2><button onclick="abrirModal('modal-decimo', 'adicionarDecimo')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div>
                <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-4 py-3">Tipo</th><th class="px-4 py-3 text-right">Bruto</th><th class="px-4 py-3 text-right text-red-500">Desc.</th><th class="px-4 py-3 text-right">L√≠quido</th><th class="px-4 py-3">Obs</th><th class="px-4 py-3 text-center">A√ß√µes</th></tr></thead><tbody id="lista-decimo" class="divide-y divide-blue-50"></tbody></table><div id="empty-decimo" class="p-4 text-center hidden">Vazio</div>
                </div>
            </div>
            
            <div id="view-outros" class="view-section hidden-section">
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold text-blue-900">PGMT Outros Bancos</h2><div class="flex gap-2"><button onclick="confirmarImportacao('OUTROS_BANCOS')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm">Copiar Anterior</button><button onclick="abrirModal('modal-outros', 'adicionarOutrosBancos')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div></div>
                <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Nome</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Banco</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">A√ß√µes</th></tr></thead>
                        <tbody id="lista-outros" class="divide-y divide-blue-50"></tbody>
                        <tfoot id="foot-outros" class="bg-gray-100 font-bold text-gray-700 hidden">
                            <tr>
                                <td colspan="3" class="px-6 py-3 text-right">TOTAL:</td>
                                <td class="px-6 py-3 text-right" id="total-outros-val"></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="empty-outros" class="p-4 text-center hidden">Vazio</div>
                </div>
            </div>
            
            <div id="view-consignados" class="view-section hidden-section">
                <div class="flex justify-between mb-4"><h2 class="text-2xl font-bold text-blue-900">Consignados</h2><button onclick="abrirModal('modal-consignados', 'adicionarConsignado')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div>
                <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">A√ß√µes</th></tr></thead>
                        <tbody id="lista-consignados" class="divide-y divide-blue-50"></tbody>
                        <tfoot id="foot-consignados" class="bg-gray-100 font-bold text-gray-700 hidden">
                            <tr>
                                <td class="px-6 py-3 text-right">TOTAL:</td>
                                <td class="px-6 py-3 text-right" id="total-consignados-val"></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="empty-consignados" class="p-4 text-center hidden">Vazio</div>
                </div>
            </div>
            
            <div id="view-adm" class="view-section hidden-section">
                <div class="mb-8">
                    <div class="flex justify-between mb-4"><h3 class="text-xl font-bold text-blue-900">Assessorias e Desp.</h3><div class="flex gap-2"><button onclick="confirmarImportacao('PAGAMENTOS_RECORRENTES')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm">Copiar Anterior</button><button onclick="abrirModal('modal-recorrentes', 'adicionarRecorrente')" class="bg-blue-600 text-white px-3 py-1.5 rounded">Adicionar</button></div></div>
                    <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Descri√ß√£o</th><th class="px-6 py-3">NF</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">A√ß√µes</th></tr></thead>
                            <tbody id="lista-recorrentes" class="divide-y divide-blue-50"></tbody>
                            <tfoot id="foot-recorrentes" class="bg-gray-100 font-bold text-gray-700 hidden">
                                <tr>
                                    <td class="px-6 py-3 text-right" colspan="2">TOTAL:</td>
                                    <td class="px-6 py-3 text-right" id="total-recorrentes-val"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div id="empty-recorrentes" class="p-4 text-center hidden">Vazio</div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-4"><h3 class="text-xl font-bold text-blue-900">Outras Despesas</h3><button onclick="abrirModal('modal-eventuais', 'adicionarOutroPagamento')" class="bg-purple-600 text-white px-3 py-1.5 rounded">Adicionar</button></div>
                    <div class="bg-white rounded shadow overflow-hidden border border-blue-100">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Descri√ß√£o</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">A√ß√µes</th></tr></thead>
                            <tbody id="lista-eventuais" class="divide-y divide-blue-50"></tbody>
                            <tfoot id="foot-eventuais" class="bg-gray-100 font-bold text-gray-700 hidden">
                                <tr>
                                    <td class="px-6 py-3 text-right">TOTAL:</td>
                                    <td class="px-6 py-3 text-right" id="total-eventuais-val"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div id="empty-eventuais" class="p-4 text-center hidden">Vazio</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS COM BOT√ÉO DE FECHAR -->
    <div id="modal-novo-usuario" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative"><button onclick="toggleModal('modal-novo-usuario')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Novo Usu√°rio</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="action_type" value="adicionarUsuario"><div class="mb-4"><label class="text-xs text-gray-500 font-bold">Usu√°rio</label><input name="novoUsuario" class="w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs text-gray-500 font-bold">Senha</label><input type="password" name="novaSenha" class="w-full border p-2 rounded" required></div><div class="flex justify-end"><button type="submit" class="bg-blue-800 text-white px-4 py-2 rounded">Criar</button></div></form></div></div>

    <div id="modal-config-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative"><button onclick="toggleModal('modal-config-guia')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Novo Tipo</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarTipoGuia"><input type="hidden" name="sheetKey" value="CONFIG_GUIAS"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Nome da Guia</label><input name="nome" class="w-full border p-2 rounded uppercase" required></div><div class="flex justify-end"><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Salvar</button></div></form></div></div>

    <div id="modal-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-purple-600 relative"><button onclick="toggleModal('modal-guia')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4 text-purple-800">Lan√ßar Guia</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarGuiaObrigacao"><input type="hidden" name="sheetKey" value="GUIAS"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Tipo</label><select name="tipo" id="select-tipo-guia" class="w-full border p-2 rounded" required></select></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-xs font-bold text-gray-500">Principal</label><input name="valorPrincipal" class="money-mask w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">D√©cimo</label><input name="valorDecimo" class="money-mask w-full border p-2 rounded"></div></div><div id="extra-fields-guia" class="hidden grid grid-cols-2 gap-4 mb-4 bg-gray-50 p-2 rounded"><div><label class="text-xs font-bold text-gray-500">Segurado</label><input name="valorSegurado" class="money-mask w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">Patronal</label><input name="valorPatronal" class="money-mask w-full border p-2 rounded"></div></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end"><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-pagamento-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 relative"><button onclick="toggleModal('modal-pagamento-guia')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4 text-green-700">Baixar</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="action_type" value="adicionarPagamentoGuia"><input type="hidden" name="idGuia" id="input-id-guia-ref"><input type="hidden" name="id"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Data</label><input type="date" name="dataPagto" class="w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valorPago" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded" placeholder="Comprovante"></div><div class="flex justify-end"><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Baixar</button></div></form></div></div>

    <!-- Modais Padr√£o (Com Bot√£o X) -->
    <div id="modal-imposto" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-imposto')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Lan√ßar IR</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarImpostoRenda"><input type="hidden" name="sheetKey" value="IMPOSTO"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Origem</label><select name="tipo" class="w-full border p-2 rounded"><option>Folha Pagamento</option><option>Nota Fiscal</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Descri√ß√£o</label><input name="descricao" class="w-full border p-2 rounded"></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>
    
    <!-- MODAL FOLHA (ATUALIZADO: BRUTO E DESCONTOS) -->
    <div id="modal-folha" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-folha')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4 text-blue-800">Folha Pagamento</h3><form onsubmit="handleSubmit(event)" oninput="calcularLiquidoVisual(this)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarFolha"><input type="hidden" name="sheetKey" value="FOLHA"><select name="tipo" class="w-full border p-2 mb-3 rounded bg-gray-50"><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select><div class="grid grid-cols-2 gap-4 mb-3"><div><label class="text-xs font-bold text-gray-500">Proventos (Bruto)</label><input name="valorBruto" class="money-mask w-full border p-2 rounded border-blue-200" placeholder="R$ 0,00" required></div><div><label class="text-xs font-bold text-gray-500">Descontos</label><input name="valorDescontos" class="money-mask w-full border p-2 rounded border-red-200" placeholder="R$ 0,00" required></div></div><div class="mb-3 p-2 bg-blue-50 rounded text-center text-sm font-bold text-blue-800" id="display-liquido-folha">L√≠quido: R$ 0,00</div><input name="obs" class="w-full border p-2 mb-4 rounded" placeholder="Observa√ß√µes"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow">Salvar</button></div></form></div></div>
    
    <!-- MODAL 13¬∫ (ATUALIZADO: BRUTO E DESCONTOS) -->
    <div id="modal-decimo" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-blue-600 relative"><button onclick="toggleModal('modal-decimo')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4 text-blue-800">13¬∫ Sal√°rio</h3><form onsubmit="handleSubmit(event)" oninput="calcularLiquidoVisual(this)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarDecimo"><input type="hidden" name="sheetKey" value="DECIMO"><select name="tipo" class="w-full border p-2 mb-3 rounded bg-gray-50"><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select><div class="grid grid-cols-2 gap-4 mb-3"><div><label class="text-xs font-bold text-gray-500">Proventos (Bruto)</label><input name="valorBruto" class="money-mask w-full border p-2 rounded border-blue-200" placeholder="R$ 0,00" required></div><div><label class="text-xs font-bold text-gray-500">Descontos</label><input name="valorDescontos" class="money-mask w-full border p-2 rounded border-red-200" placeholder="R$ 0,00" required></div></div><div class="mb-3 p-2 bg-blue-50 rounded text-center text-sm font-bold text-blue-800" id="display-liquido-decimo">L√≠quido: R$ 0,00</div><input name="obs" class="w-full border p-2 mb-4 rounded" placeholder="Observa√ß√µes"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow">Salvar</button></div></form></div></div>
    
    <div id="modal-outros" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-outros')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Outros</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutrosBancos"><input type="hidden" name="sheetKey" value="OUTROS_BANCOS"><input name="nome" class="w-full border p-2 mb-2" placeholder="Nome"><select name="tipo" class="w-full border p-2 mb-2"><option>Aposentado</option><option>Pensionista</option><option>Comissionado</option></select><input name="banco" class="w-full border p-2 mb-2" placeholder="Banco"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-consignados" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-consignados')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Consignado</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarConsignado"><input type="hidden" name="sheetKey" value="CONSIGNADOS"><input name="tipo" class="w-full border p-2 mb-2" placeholder="Tipo/Banco"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <!-- MODAL ASSESSORIAS ATUALIZADO (CAMPO NF) -->
    <div id="modal-recorrentes" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-recorrentes')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Assessoria</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarRecorrente"><input type="hidden" name="sheetKey" value="RECORRENTES"><input name="descricao" class="w-full border p-2 mb-2" placeholder="Descri√ß√£o"><select name="tipo" class="w-full border p-2 mb-2"><option>Assessoria</option><option>Servi√ßo</option></select><input name="notaFiscal" class="w-full border p-2 mb-2" placeholder="Nota Fiscal (N¬∫)"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-eventuais" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative"><button onclick="toggleModal('modal-eventuais')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button><h3 class="font-bold text-lg mb-4">Eventual</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutroPagamento"><input type="hidden" name="sheetKey" value="OUTROS_PGTOS"><input name="descricao" class="w-full border p-2 mb-2" placeholder="Descri√ß√£o"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwt5wH_wT65wfXyaBc78YK4ZBHcCi7zFATSQRk6yytCTHFlqCLs1Gc7JSS395aYNUmR/exec";
        let currentCompetencia = "";
        let authToken = localStorage.getItem('rpps_token');
        let currentUser = localStorage.getItem('rpps_user');
        
        let confirmCallback = null;
        let CACHE = {};
        let pendingHighlightId = null;
        
        let financeChart = null;

        // --- 1. FUN√á√ïES GLOBAIS E UTILIT√ÅRIAS ---
        
        function formatCurrency(v) { 
            if(v === undefined || v === null || v === '') return 'R$ 0,00';
            if(typeof v === 'number') return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            let str = v.toString();
            if(str.includes(',')) { str = str.replace(/\./g, '').replace(',', '.'); }
            str = str.replace(/[R$\s]/g, '');
            return parseFloat(str || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); 
        }
        
        function parseValue(v) {
            if(typeof v === 'number') return v;
            if(!v) return 0;
            let str = v.toString();
            if(str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
            str = str.replace(/[R$\s]/g, '');
            return parseFloat(str || 0);
        }

        function showToast(msg, type) { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = msg; 
            t.className = type; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        function setupMoneyMask() { 
            document.querySelectorAll('.money-mask').forEach(i => i.addEventListener('input', e => { 
                let v = e.target.value.replace(/\D/g,""); 
                v = (v/100).toFixed(2) + ""; 
                e.target.value = "R$ " + v.replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."); 
            })); 
        }

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function setLoading(act) { document.getElementById('loadingOverlay').classList.toggle('hidden', !act); }

        function openConfirm(msg, callback) { 
            document.getElementById('confirm-msg').innerText = msg; 
            document.getElementById('modal-confirm').classList.remove('hidden'); 
            confirmCallback = callback; 
        }
        
        function closeConfirm(yes) { 
            document.getElementById('modal-confirm').classList.add('hidden'); 
            if(yes && confirmCallback) confirmCallback(); 
            confirmCallback = null; 
        }

        function calcularLiquidoVisual(form) {
            const bruto = parseFloat(form.valorBruto.value.replace(/\D/g, '') || 0) / 100;
            const desc = parseFloat(form.valorDescontos.value.replace(/\D/g, '') || 0) / 100;
            const liq = bruto - desc;
            const div = form.querySelector('div[id^="display-liquido"]');
            if(div) div.innerText = "L√≠quido: " + liq.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
        }

        // --- NOVA FUN√á√ÉO: CALCULAR MARGEM VISUAL ---
        function calcularMargemVisual(form) {
            const bruto = parseValue(form.querySelector('[name="bruto"]').value);
            const descontos = parseValue(form.querySelector('[name="descontos"]').value);
            const usoAtual = parseValue(form.querySelector('[name="usoAtual"]').value);
            const porcentagem = parseFloat(form.querySelector('[name="porcentagem"]').value) || 35;

            const liquido = bruto - descontos;
            const margemPermitida = liquido * (porcentagem / 100);
            const disponivel = margemPermitida - usoAtual;

            document.getElementById('display-calc-liquido').innerText = formatCurrency(liquido);
            document.getElementById('display-calc-permitida').innerText = formatCurrency(margemPermitida);
            document.getElementById('display-calc-disponivel').innerText = formatCurrency(disponivel);

            form.querySelector('[name="liquido"]').value = liquido.toFixed(2);
            form.querySelector('[name="margemPermitida"]').value = margemPermitida.toFixed(2);
            form.querySelector('[name="disponivel"]').value = disponivel.toFixed(2);
            
            const dispEl = document.getElementById('display-calc-disponivel');
            if(disponivel < 0) {
                dispEl.classList.remove('text-teal-600');
                dispEl.classList.add('text-red-600');
            } else {
                dispEl.classList.remove('text-red-600');
                dispEl.classList.add('text-teal-600');
            }
        }

        function irParaPendencia(competencia, id) {
            pendingHighlightId = id;
            showView('conferencia');
            showToast(`Localizando pend√™ncia...`, 'success');
        }

        // --- 2. HELPERS DE A√á√ÉO E RENDERIZADORES ---

        function getActions(key, row, idIdx) {
            const id = row[idIdx]; 
            const safe = s => String(s).replace(/'/g,"\\'").replace(/"/g,"&quot;"); 
            let params = "{}";
            
            if(key==='IMPOSTO') params=`{id:'${id}', tipo:'${safe(row[1])}', descricao:'${safe(row[2])}', valor:'${safe(row[3])}', obs:'${safe(row[4])}'}`;
            
            if(key==='FOLHA') params=`{id:'${id}', tipo:'${safe(row[1])}', valorBruto:'${safe(row[2])}', valorDescontos:'${safe(row[3])}', obs:'${safe(row[5])}'}`;
            if(key==='DECIMO') params=`{id:'${id}', tipo:'${safe(row[1])}', valorBruto:'${safe(row[2])}', valorDescontos:'${safe(row[3])}', obs:'${safe(row[5])}'}`;
            
            if(key==='CONSIGNADOS') params=`{id:'${id}', tipo:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[3])}'}`;
            if(key==='OUTROS_BANCOS') params=`{id:'${id}', nome:'${safe(row[1])}', tipo:'${safe(row[2])}', banco:'${safe(row[3])}', valor:'${safe(row[4])}', obs:'${safe(row[5])}'}`;
            
            if(key==='RECORRENTES') params=`{id:'${id}', descricao:'${safe(row[1])}', tipo:'${safe(row[2])}', valor:'${safe(row[3])}', notaFiscal:'${safe(row[4])}', obs:'${safe(row[6])}'}`;
            
            if(key==='OUTROS_PGTOS') params=`{id:'${id}', descricao:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[4])}'}`;
            
            let modal = 'modal-folha'; 
            let action = 'adicionarFolha';
            
            if(key==='IMPOSTO') { modal='modal-imposto'; action='adicionarImpostoRenda'; }
            else if(key==='DECIMO') { modal='modal-decimo'; action='adicionarDecimo'; }
            else if(key==='CONSIGNADOS') { modal='modal-consignados'; action='adicionarConsignado'; }
            else if(key==='OUTROS_BANCOS') { modal='modal-outros'; action='adicionarOutrosBancos'; }
            else if(key==='RECORRENTES') { modal='modal-recorrentes'; action='adicionarRecorrente'; }
            else if(key==='OUTROS_PGTOS') { modal='modal-eventuais'; action='adicionarOutroPagamento'; }
            
            return `<button onclick="abrirModal('${modal}','${action}',${params})" class="text-blue-500 mr-2 hover:bg-blue-100 p-1 rounded transition"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('${key}','${id}')" class="text-red-400 hover:bg-red-100 p-1 rounded transition"><i class="fas fa-trash"></i></button>`;
        }

        // Renderers Padronizados
        function renderRowImposto(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-bold text-blue-900">${row[1]}</td><td class="p-3 text-blue-800">${row[2]}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[3])}</td><td class="p-3 text-xs text-blue-500">${row[4]}</td><td class="p-3 text-center">${getActions('IMPOSTO', row, 6)}</td></tr>`; }
        function renderRowFolha(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-medium text-gray-500">${formatCurrency(row[2])}</td><td class="p-3 text-right font-medium text-red-400 text-xs">-${formatCurrency(row[3])}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-500">${row[5]}</td><td class="p-3 text-center">${getActions('FOLHA', row, 8)}</td></tr>`; }
        function renderRowDecimo(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-medium text-gray-500">${formatCurrency(row[2])}</td><td class="p-3 text-right font-medium text-red-400 text-xs">-${formatCurrency(row[3])}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-500">${row[5]}</td><td class="p-3 text-center">${getActions('DECIMO', row, 8)}</td></tr>`; }
        function renderRowOutros(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-xs text-blue-500">${row[2]}</td><td class="p-3 text-blue-800">${row[3]}</td><td class="p-3 text-right font-bold text-orange-600">${formatCurrency(row[4])}</td><td class="p-3 text-xs text-blue-400">${row[5]}</td><td class="p-3 text-center">${getActions('OUTROS_BANCOS', row, 8)}</td></tr>`; }
        function renderRowConsig(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-bold text-purple-600">${formatCurrency(row[2])}</td><td class="p-3 text-xs text-blue-500">${row[3]}</td><td class="p-3 text-center">${getActions('CONSIGNADOS', row, 6)}</td></tr>`; }
        function renderRowRecorrente(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}<br><span class="text-xs text-gray-400">${row[2]}</span></td><td class="p-3 text-xs font-bold text-gray-500">${row[4] || '-'}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[3])}</td><td class="p-3 text-center">${getActions('RECORRENTES', row, 7)}</td></tr>`; }
        function renderRowEventual(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[2])}</td><td class="p-3 text-center">${getActions('OUTROS_PGTOS', row, 5)}</td></tr>`; }
        
        // NOVO: Renderer para Hist√≥rico de Margem
        function renderRowMargem(row) {
            const disponivel = parseValue(row[8]);
            const colorDisp = disponivel < 0 ? 'text-red-600' : 'text-teal-600';
            return `<tr class="border-b hover:bg-teal-50 border-teal-100">
                <td class="p-3 font-medium text-gray-800">${row[1]}</td>
                <td class="p-3 text-right text-gray-600">${formatCurrency(row[4])}</td>
                <td class="p-3 text-right text-gray-600 font-bold">${formatCurrency(row[6])}</td>
                <td class="p-3 text-right text-red-500 text-xs">${formatCurrency(row[7])}</td>
                <td class="p-3 text-right ${colorDisp} font-extrabold text-lg">${formatCurrency(row[8])}</td>
                <td class="p-3 text-center"><button onclick="excluir('MARGEM','${row[10]}')" class="text-red-400 hover:bg-red-100 p-1 rounded transition"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        }

        // --- 3. FETCH E LOGICA DE DADOS ---

        async function fetchData(action, params = '') {
            const cacheKey = `${action}_${currentCompetencia}_${params}`;
            if (CACHE[cacheKey]) { return CACHE[cacheKey]; }
            try {
                const res = await fetch(`${API_URL}?action=${action}&competencia=${currentCompetencia}&token=${authToken}&${params}`);
                const json = await res.json();
                if (json.status === 'success') { CACHE[cacheKey] = json; }
                return json;
            } catch(e) { console.log(e); return {status:'error'}; }
        }
        function invalidateCache() { CACHE = {}; }

        // --- 4. FUN√á√ïES DE CARREGAMENTO ---

        function renderLista(json, tbodyId, emptyId, renderFn, sheetType) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            let sumBruto = 0, sumDesc = 0, sumLiq = 0;
            if(json.data && json.data.length > 0) {
                document.getElementById(emptyId).classList.add('hidden');
                json.data.forEach(r => {
                    tbody.innerHTML += renderFn(r);
                    if(sheetType === 'FOLHA' || sheetType === 'DECIMO') {
                        sumBruto += parseValue(r[2]); sumDesc += parseValue(r[3]); sumLiq += parseValue(r[4]);
                    } else if (sheetType === 'OUTROS') sumLiq += parseValue(r[4]);
                    else if (sheetType === 'CONSIGNADOS' || sheetType === 'EVENTUAIS') sumLiq += parseValue(r[2]);
                    else if (sheetType === 'RECORRENTES' || sheetType === 'IMPOSTO') sumLiq += parseValue(r[3]);
                });
                updateFooter(sheetType, sumBruto, sumDesc, sumLiq);
            } else { 
                document.getElementById(emptyId).classList.remove('hidden'); 
                const footerId = getFooterId(sheetType);
                if(footerId) document.getElementById(footerId).classList.add('hidden');
            }
        }
        
        function getFooterId(type) {
            if(type === 'FOLHA') return 'foot-folha';
            if(type === 'DECIMO') return 'foot-decimo';
            if(type === 'OUTROS') return 'foot-outros';
            if(type === 'CONSIGNADOS') return 'foot-consignados';
            if(type === 'RECORRENTES') return 'foot-recorrentes';
            if(type === 'EVENTUAIS') return 'foot-eventuais';
            if(type === 'IMPOSTO') return 'foot-imposto';
            return null;
        }

        function updateFooter(type, bruto, desc, liq) {
            const fid = getFooterId(type);
            if(!fid) return;
            const foot = document.getElementById(fid);
            foot.classList.remove('hidden');
            if(type === 'FOLHA' || type === 'DECIMO') {
                document.getElementById(`total-${type.toLowerCase()}-bruto`).innerText = formatCurrency(bruto);
                document.getElementById(`total-${type.toLowerCase()}-desc`).innerText = '-' + formatCurrency(desc);
                document.getElementById(`total-${type.toLowerCase()}-liq`).innerText = formatCurrency(liq);
            } else {
                const el = document.getElementById(`total-${type.toLowerCase()}-val`);
                if(el) el.innerText = formatCurrency(liq);
            }
        }
        
        // Helper seguro para setar innerText sem erro de nulo
        function setElementText(id, value) {
            const el = document.getElementById(id);
            if(el) el.innerText = value;
        }

        async function carregarLista(sheet, tbodyId, emptyId, renderFn, force = false) {
            if(force) invalidateCache();
            const cacheKey = `getList_${currentCompetencia}_sheet=${sheet}`;
            let sheetType = '';
            if(sheet === 'FOLHA_PAGAMENTO') sheetType = 'FOLHA';
            else if(sheet === 'DECIMO_TERCEIRO') sheetType = 'DECIMO';
            else if(sheet === 'OUTROS_BANCOS') sheetType = 'OUTROS';
            else if(sheet === 'CONSIGNADOS') sheetType = 'CONSIGNADOS';
            else if(sheet === 'PAGAMENTOS_RECORRENTES') sheetType = 'RECORRENTES';
            else if(sheet === 'OUTROS_PAGAMENTOS') sheetType = 'EVENTUAIS';
            else if(sheet === 'IMPOSTO_RENDA') sheetType = 'IMPOSTO';
            else if(sheet === 'HISTORICO_MARGEM') sheetType = 'MARGEM'; 

            if (!force && CACHE[cacheKey]) { renderLista(CACHE[cacheKey], tbodyId, emptyId, renderFn, sheetType); return; }
            setLoading(true);
            const json = await fetchData('getList', `sheet=${sheet}`);
            renderLista(json, tbodyId, emptyId, renderFn, sheetType);
            setLoading(false);
        }

        function showView(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('tab-active'));
            document.getElementById(`view-${view}`).classList.remove('hidden-section');
            document.getElementById(`btn-${view}`).classList.add('tab-active');
            
            if(view === 'resumo') carregarResumo();
            else if(view === 'graficos') carregarHistorico();
            else if(view === 'conferencia') carregarConferencia();
            else if(view === 'margem') carregarMargem(); // Nova view
            else if(view === 'folha') carregarLista('FOLHA_PAGAMENTO', 'lista-folha', 'empty-folha', renderRowFolha);
            else if(view === 'imposto') carregarLista('IMPOSTO_RENDA', 'lista-imposto', 'empty-imposto', renderRowImposto);
            else if(view === 'outros') carregarLista('OUTROS_BANCOS', 'lista-outros', 'empty-outros', renderRowOutros);
            else if(view === 'consignados') carregarLista('CONSIGNADOS', 'lista-consignados', 'empty-consignados', renderRowConsig);
            else if(view === 'adm') { 
                carregarLista('PAGAMENTOS_RECORRENTES', 'lista-recorrentes', 'empty-recorrentes', renderRowRecorrente); 
                carregarLista('OUTROS_PAGAMENTOS', 'lista-eventuais', 'empty-eventuais', renderRowEventual); 
            }
            else if(view === 'pendencias') carregarPendencias();
            else if(view === 'decimo') carregarLista('DECIMO_TERCEIRO', 'lista-decimo', 'empty-decimo', renderRowDecimo);
            else if(view === 'guias') carregarGuias();
        }

        async function carregarMargem() {
            carregarLista('HISTORICO_MARGEM', 'lista-margem', 'empty-margem', renderRowMargem);
        }

        async function carregarResumo(force = false) {
            if(force) invalidateCache();
            const cacheKey = `getResumoMensal_${currentCompetencia}_`;
            if (!force && CACHE[cacheKey]) { renderResumo(CACHE[cacheKey]); return; }
            if(!force) setLoading(true);
            const json = await fetchData('getResumoMensal');
            renderResumo(json);
            setLoading(false);
        }
        
        function renderResumo(json) {
             if(json.status === 'success') {
                // Verifica√ß√£o de seguran√ßa para evitar erro em dados nulos
                const brutoNormal = json.folha.total_bruto_normal || 0;
                const brutoDecimo = json.folha.total_bruto_decimo || 0;
                const brutoTotal = brutoNormal + brutoDecimo;
                
                // Uso da fun√ß√£o auxiliar setElementText para evitar erros de elemento nulo
                setElementText('dash-total-bruto', formatCurrency(brutoTotal));
                setElementText('dash-total-liquido', formatCurrency(json.folha.total_geral));
                setElementText('dash-total-bradesco', formatCurrency(json.bancos.bradesco));
                setElementText('dash-total-outros', formatCurrency(json.bancos.outros));
                setElementText('dash-total-imposto', formatCurrency(json.imposto.total));
                setElementText('dash-total-consig', formatCurrency(json.consignados.total));
                setElementText('dash-total-adm', formatCurrency(json.administrativo.total));
                setElementText('dash-recolhimento-pago', formatCurrency(json.recolhimento.pago));
                setElementText('dash-recolhimento-devido', formatCurrency(json.recolhimento.devido));
                setElementText('conf-folha', formatCurrency(json.folha.total_geral));
                setElementText('conf-outros', formatCurrency(json.bancos.outros));
                setElementText('conf-bradesco', formatCurrency(json.bancos.bradesco));
            }
        }

        async function carregarHistorico(force = false) {
            setLoading(true);
            const yearInput = document.getElementById('chartYearInput');
            const anoSelecionado = yearInput.value || new Date().getFullYear();
            const meses = [];
            for (let i = 1; i <= 12; i++) meses.push(`${String(i).padStart(2,'0')}/${anoSelecionado}`);

            const promises = meses.map(comp => 
                fetch(`${API_URL}?action=getResumoMensal&competencia=${comp}&token=${authToken}`)
                .then(r => r.json())
            );
            
            const resultados = await Promise.all(promises);
            const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            const dadosDespesa = [];
            const dadosReceita = [];
            const tabelaBody = document.getElementById('table-analise-body');
            tabelaBody.innerHTML = '';

            resultados.forEach((r, idx) => {
                if(r.status === 'success') {
                    const folhaBruta = (r.folha.total_bruto_normal || 0) + (r.folha.total_bruto_decimo || 0);
                    const outrasDesp = (r.administrativo.total || 0);
                    const totalDespesa = folhaBruta + outrasDesp; 
                    const repasse = r.recolhimento.pago || 0;
                    const resultado = totalDespesa - repasse;
                    const resCor = resultado > 0 ? 'text-red-600' : 'text-blue-600'; 
                    const resSinal = resultado > 0 ? '+' : ''; 

                    dadosDespesa.push(totalDespesa);
                    dadosReceita.push(repasse);

                    tabelaBody.innerHTML += `
                        <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                            <td class="px-4 py-3 font-medium text-gray-600">${labels[idx]}</td>
                            <td class="px-4 py-3 text-right text-gray-500">${formatCurrency(folhaBruta)}</td>
                            <td class="px-4 py-3 text-right text-gray-400 text-xs">${formatCurrency(outrasDesp)}</td>
                            <td class="px-4 py-3 text-right font-bold text-gray-700 bg-gray-50">${formatCurrency(totalDespesa)}</td>
                            <td class="px-4 py-3 text-right text-green-600">${formatCurrency(repasse)}</td>
                            <td class="px-4 py-3 text-right font-extrabold ${resCor}">${resSinal}${formatCurrency(resultado)}</td>
                        </tr>
                    `;
                } else {
                    dadosDespesa.push(0); dadosReceita.push(0);
                    tabelaBody.innerHTML += `<tr><td colspan="6" class="px-4 py-3 text-center text-xs text-gray-400">Sem dados para ${labels[idx]}</td></tr>`;
                }
            });

            renderizarGraficoHistorico(labels, dadosDespesa, dadosReceita);
            setLoading(false);
        }

        function renderizarGraficoHistorico(labels, dataDespesa, dataReceita) {
            const ctx = document.getElementById('historicalChart').getContext('2d');
            if(financeChart) financeChart.destroy();

            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Despesas Totais (Bruto)', data: dataDespesa, backgroundColor: '#ef4444', borderRadius: 4 },
                        { label: 'Repasses (Guias)', data: dataReceita, backgroundColor: '#22c55e', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR', {compactDisplay:'short', notation:'compact'}) } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(ctx.parsed.y)
                            }
                        }
                    }
                }
            });
        }

        // --- 6. FUN√á√ïES DE DADOS ESPEC√çFICOS ---

        async function carregarGuias() {
            setLoading(true); 
            const json = await fetchData('getGuiasDetalhadas');
            const container = document.getElementById('container-guias');
            const empty = document.getElementById('empty-guias');
            container.innerHTML = '';
            if(json.status === 'success' && json.data.length > 0) {
                empty.classList.add('hidden');
                json.data.forEach(g => {
                    const pendente = g.totalDevido - g.totalPago;
                    const statusColor = pendente <= 0.01 ? 'bg-green-100 border-green-500' : 'bg-white border-purple-200';
                    const statusText = pendente <= 0.01 ? '<span class="text-green-600 font-bold">QUITADO</span>' : `<span class="text-red-600 font-bold">Resta: ${formatCurrency(pendente)}</span>`;
                    let pgtosHtml = '';
                    if(g.pagamentos && g.pagamentos.length > 0) {
                        pgtosHtml = `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500"><p class="font-bold mb-1">Hist√≥rico:</p>`;
                        g.pagamentos.forEach(p => { pgtosHtml += `<div class="flex justify-between"><span>${p.data.split('T')[0]} - ${p.obs}</span> <span>${formatCurrency(p.valor)}</span></div>`; });
                        pgtosHtml += `</div>`;
                    }
                    let detalhesValores = `Princ: ${formatCurrency(g.vPrincipal)} | 13¬∫: ${formatCurrency(g.vDecimo)}`;
                    if(g.tipo.includes('ENFERMAGEM')) detalhesValores = `Seg: ${formatCurrency(g.vSegurado)} | Patr: ${formatCurrency(g.vPatronal)}`;
                    container.innerHTML += `<div class="rounded-lg border-l-4 shadow-sm p-4 ${statusColor}"><div class="flex justify-between items-start"><div><h3 class="font-bold text-gray-800 text-lg">${g.tipo}</h3><p class="text-xs text-gray-500 font-mono">${detalhesValores}</p><div class="mt-2 text-sm">Devido: <strong>${formatCurrency(g.totalDevido)}</strong> <span class="mx-2 text-gray-300">|</span> Pago: <strong>${formatCurrency(g.totalPago)}</strong></div></div><div class="text-right">${statusText}<div class="mt-2 flex gap-1 justify-end"><button onclick="abrirModalPagamento('${g.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow"><i class="fas fa-check"></i> Pagar</button><button onclick="editarGuia('${g.id}', '${g.tipo}', '${g.vPrincipal}', '${g.vDecimo}', '${g.vSegurado}', '${g.vPatronal}', '${g.obs}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('GUIAS', '${g.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-200"><i class="fas fa-trash"></i></button></div></div></div>${pgtosHtml}</div>`;
                });
            } else { empty.classList.remove('hidden'); }
            setLoading(false);
        }

        async function carregarConferencia(force = false) {
            if(force) invalidateCache();
            const cacheKey = `getConferencia_${currentCompetencia}_`;
            if (!force && CACHE[cacheKey]) { renderConferencia(CACHE[cacheKey]); return; }
            setLoading(true);
            const json = await fetchData('getConferencia');
            renderConferencia(json);
            setLoading(false);
        }

        function renderConferencia(json) {
            const container = document.getElementById('conferencia-container');
            const empty = document.getElementById('empty-conferencia');
            container.innerHTML = '';
            if(json.status === 'success' && json.data.length > 0) {
                empty.classList.add('hidden');
                const grupos = {};
                json.data.forEach(item => { if(!grupos[item.grupo]) grupos[item.grupo] = []; grupos[item.grupo].push(item); });
                for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                    let rows = '';
                    itens.forEach(item => {
                        const isPago = item.status === 'Pago';
                        const switchHtml = `<label class="switch"><input type="checkbox" ${isPago ? 'checked' : ''} onchange="togglePagamento('${item.id}', '${item.origem}', this)"><span class="slider"></span></label><span class="switch-label">${isPago ? 'PAGO' : 'PENDENTE'}</span>`;
                        
                        const compHtml = `<span class="inline-block bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-100 mt-1"><i class="far fa-calendar-alt mr-1"></i>${item.competencia}</span>`;
                        const rowClass = isPago 
                            ? 'bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300' 
                            : 'bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300';
                        const textClass = isPago ? 'text-gray-400 line-through' : 'text-gray-900';

                        rows += `<tr id="row-${item.id}" class="border-b last:border-0 ${rowClass}">
                            <td class="px-6 py-4 w-1/4">
                                <div class="text-xs font-bold uppercase text-gray-500">${item.origem}</div>
                                ${compHtml}
                            </td>
                            <td class="px-6 py-4 font-medium ${textClass} w-1/3">${item.descricao}</td>
                            <td class="px-6 py-4 text-right font-bold w-1/4">${formatCurrency(item.valor)}</td>
                            <td class="px-6 py-4 text-center flex items-center justify-center">${switchHtml}</td>
                        </tr>`;
                    });
                    container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-700">${nomeGrupo}</h3><span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">${itens.length}</span></div><table class="w-full text-sm text-left"><tbody class="divide-y divide-gray-100">${rows}</tbody></table></div>`;
                }
            } else { empty.classList.remove('hidden'); }

            if (pendingHighlightId) {
                const el = document.getElementById(`row-${pendingHighlightId}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlight-row');
                    setTimeout(() => { el.classList.remove('highlight-row'); }, 3000);
                }
                pendingHighlightId = null; 
            }
        }

        async function carregarPendencias(force=false) {
             if(force) invalidateCache();
             const cacheKey = `getPendencias_${currentCompetencia}_`; 
             if(!force && CACHE['getPendencias_']) { renderPendencias(CACHE['getPendencias_']); return; }
             setLoading(true);
             const json = await fetchData('getPendencias'); 
             CACHE['getPendencias_'] = json; 
             renderPendencias(json);
             setLoading(false);
        }

        function renderPendencias(json) {
            const container = document.getElementById('pendencias-container');
            const emptyDiv = document.getElementById('empty-pendencias');
            container.innerHTML = '';
            if(json.status === 'success' && json.data.length > 0) {
                emptyDiv.classList.add('hidden');
                const grupos = {};
                json.data.forEach(item => { const grp = item.grupo || 'Geral'; if(!grupos[grp]) grupos[grp] = []; grupos[grp].push(item); });
                for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                    let rows = '';
                    itens.forEach(row => {
                        let badgeClass = 'bg-red-100 text-red-600'; if(row.status === 'A Receber') badgeClass = 'bg-purple-100 text-purple-600';
                        rows += `<tr onclick="irParaPendencia('${row.competencia}', '${row.idOriginal}')" class="hover:bg-red-50 border-b border-red-100 last:border-0 cursor-pointer transition-colors" title="Clique para resolver em ${row.competencia}">
                            <td class="px-6 py-3 text-sm font-bold text-gray-700 w-1/6">${row.competencia}</td>
                            <td class="px-6 py-3 text-xs uppercase text-gray-500 w-1/6">${row.origem}</td>
                            <td class="px-6 py-3 text-sm text-gray-800 font-medium w-1/3">${row.descricao}</td>
                            <td class="px-6 py-3 text-right font-bold text-gray-800 w-1/6">${formatCurrency(row.valor)}</td>
                            <td class="px-6 py-3 text-center w-1/6"><span class="${badgeClass} font-bold text-xs px-2 py-1 rounded">${row.status}</span></td>
                        </tr>`;
                    });
                    container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-red-100 mb-6"><div class="bg-red-50 px-6 py-3 border-b border-red-100 flex justify-between items-center"><h3 class="font-bold text-red-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>${nomeGrupo}</h3><span class="bg-white text-red-600 text-xs px-2 py-1 rounded-full font-bold border border-red-200">${itens.length} itens</span></div><table class="w-full text-left"><tbody class="divide-y divide-red-50">${rows}</tbody></table></div>`;
                }
            } else { emptyDiv.classList.remove('hidden'); }
        }

        // --- 7. A√á√ïES DE FORMUL√ÅRIO E UI ---

        async function handleSubmit(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.action = data.id ? 'editarRegistro' : data.action_type;
            data.competencia = currentCompetencia;
            data.usuarioLog = currentUser;
            
            const modalEl = e.target.closest('div[id^="modal"]');
            if(modalEl) toggleModal(modalEl.id);
            
            invalidateCache();
            setLoading(true);
            try {
                const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)});
                const json = await res.json();
                showToast(json.status==='success'?'Salvo!':'Erro', json.status);
                
                if(data.action_type === 'adicionarCalculoMargem') {
                    carregarMargem(); 
                } else if(data.action_type === 'adicionarGuiaObrigacao' || data.action_type === 'adicionarPagamentoGuia') { 
                    carregarGuias(); 
                } else { 
                    const activeBtn = document.querySelector('.nav-btn.tab-active');
                    if(activeBtn && activeBtn.id !== 'btn-margem') activeBtn.click();
                }
            } catch(e) { showToast('Erro', 'error'); } finally { setLoading(false); }
        }

        async function togglePagamento(id, origem, checkbox) {
            checkbox.disabled = true;
            checkbox.classList.add('pointer-events-none');
            
            const novoStatus = checkbox.checked ? 'Pago' : 'Pendente';
            const label = checkbox.parentElement.nextElementSibling;
            label.innerText = novoStatus === 'Pago' ? 'PAGO' : 'PENDENTE';
            
            const tr = checkbox.closest('tr');
            const desc = tr.querySelector('td:nth-child(2)'); 
            
            if(novoStatus === 'Pago') {
                tr.className = "border-b last:border-0 bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300";
                desc.classList.add('text-gray-400', 'line-through');
                desc.classList.remove('text-gray-900');
            } else {
                tr.className = "border-b last:border-0 bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300";
                desc.classList.remove('text-gray-400', 'line-through');
                desc.classList.add('text-gray-900');
            }

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'atualizarStatusPagamento', id, origem, novoStatus, usuarioLog: currentUser }) });
                const json = await res.json();
                
                if(json.status !== 'success') {
                    throw new Error('Erro no servidor'); 
                }
                invalidateCache();
            } catch(e) { 
                checkbox.checked = !checkbox.checked; 
                label.innerText = checkbox.checked ? 'PAGO' : 'PENDENTE';
                if(!checkbox.checked) {
                    tr.className = "border-b last:border-0 bg-white hover:bg-gray-50 shadow-[inset_5px_0_0_0_transparent] transition-colors duration-300";
                    desc.classList.remove('text-gray-400', 'line-through');
                    desc.classList.add('text-gray-900');
                } else {
                    tr.className = "border-b last:border-0 bg-emerald-100 shadow-[inset_5px_0_0_0_#10b981] transition-colors duration-300";
                    desc.classList.add('text-gray-400', 'line-through');
                    desc.classList.remove('text-gray-900');
                }
                showToast('Erro ao atualizar', 'error'); 
            } finally { 
                checkbox.disabled = false; 
                checkbox.classList.remove('pointer-events-none');
            }
        }

        async function carregarTiposParaSelect() {
            const res = await fetchData('getConfigGuias');
            const select = document.getElementById('select-tipo-guia');
            select.innerHTML = '';
            if(res.status === 'success') { res.data.forEach(t => { select.innerHTML += `<option value="${t.nome}">${t.nome}</option>`; }); }
        }
        
        function abrirModalPagamento(idGuia) { document.getElementById('input-id-guia-ref').value = idGuia; const hoje = new Date().toISOString().split('T')[0]; document.querySelector('#modal-pagamento-guia input[type="date"]').value = hoje; toggleModal('modal-pagamento-guia'); }
        
        function editarGuia(id, tipo, vPrinc, vDec, vSeg, vPatr, obs) { abrirModal('modal-guia', 'adicionarGuiaObrigacao', { id: id, tipo: tipo, valorPrincipal: vPrinc, valorDecimo: vDec, valorSegurado: vSeg, valorPatronal: vPatr, obs: obs }); const select = document.getElementById('select-tipo-guia'); select.value = tipo; select.dispatchEvent(new Event('change')); }
        
        function confirmarImportacao(sheetTarget) { openConfirm(`Copiar registros do m√™s anterior para ${currentCompetencia}?`, async () => { setLoading(true); try { const res = await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'importarMesAnterior', sheetTarget, competenciaAtual:currentCompetencia, usuarioLog:currentUser})}); const json = await res.json(); invalidateCache(); showToast(json.status==='success'?'Sucesso!':'Erro', json.status); if(json.status==='success') document.querySelector('.nav-btn.tab-active').click(); } catch(e) { showToast('Erro conex√£o', 'error'); } finally { setLoading(false); } }); }
        
        async function excluir(sheetKey, id) { openConfirm("Excluir este registro?", async () => { setLoading(true); await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'excluirRegistro', sheetName:sheetKey, id, competencia:currentCompetencia, usuarioLog:currentUser})}); invalidateCache(); showToast('Exclu√≠do', 'success'); if(sheetKey === 'GUIAS') carregarGuias(); else if(sheetKey === 'MARGEM') carregarMargem(); else document.querySelector('.nav-btn.tab-active').click(); setLoading(false); }); }
        
        function abrirModal(id, action, editData=null) {
            const m = document.getElementById(id);
            const f = m.querySelector('form');
            if (!f) return;
            f.reset();
            const actionInput = f.querySelector('[name="action_type"]');
            if (actionInput) actionInput.value = action;
            const idInput = f.querySelector('[name="id"]');
            if (idInput) idInput.value = "";
            const titleEl = m.querySelector('h3');
            if (titleEl) titleEl.innerText = titleEl.innerText.replace('Editar', 'Adicionar');
            if (editData) {
                if (idInput) idInput.value = editData.id;
                for (let k in editData) {
                    const input = f.querySelector(`[name="${k}"]`);
                    if (input) { input.value = k.includes('valor') ? formatCurrency(editData[k]) : editData[k]; }
                }
                
                if(id === 'modal-folha' || id === 'modal-decimo') calcularLiquidoVisual(f);

                if (titleEl) titleEl.innerText = titleEl.innerText.replace('Adicionar', 'Editar');
            }
            toggleModal(id);
        }

        // --- 8. INICIALIZA√á√ÉO ---
        window.onload = async function() {
            if(authToken) {
                if(currentUser && currentUser !== 'undefined') atualizarNomeUsuario(currentUser);
                try {
                    const res = await fetch(`${API_URL}?action=verificarToken&token=${authToken}`);
                    const json = await res.json();
                    if(json.status === 'success') {
                        currentUser = json.usuario;
                        localStorage.setItem('rpps_user', currentUser);
                        iniciarSistema();
                    } else { throw new Error('Token inv√°lido'); }
                } catch(e) { console.log("Sess√£o inv√°lida..."); logout(false); }
            } else { document.getElementById('login-screen').style.display = 'flex'; }
        };

        function iniciarSistema() {
            document.getElementById('login-screen').style.display = 'none';
            if(currentUser) atualizarNomeUsuario(currentUser);
            const d = new Date();
            const anoAtual = d.getFullYear();
            const v = `${anoAtual}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('inputCompetencia').value = v;
            document.getElementById('chartYearInput').value = anoAtual;
            mudarCompetencia(v);
            setupMoneyMask();
            document.getElementById('select-tipo-guia').addEventListener('change', function() {
                const isPiso = this.value.includes('ENFERMAGEM');
                document.getElementById('extra-fields-guia').classList.toggle('hidden', !isPiso);
            });
            preCarregarDados();
        }

        function atualizarNomeUsuario(nome) {
            document.getElementById('user-display').innerHTML = `<i class="fas fa-user-circle mr-2"></i>Ol√°, <strong>${nome}</strong>`;
        }
        
        function preCarregarDados() {
            const views = ['getResumoMensal', 'getConferencia', 'getPendencias', 'getGuiasDetalhadas'];
            views.forEach(v => fetchData(v));
            const lists = ['FOLHA_PAGAMENTO', 'DECIMO_TERCEIRO', 'OUTROS_BANCOS', 'CONSIGNADOS', 'PAGAMENTOS_RECORRENTES', 'IMPOSTO_RENDA'];
            lists.forEach(l => fetchData('getList', `sheet=${l}`));
        }

        function handleLogin(e) { 
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            const msg = document.getElementById('login-msg');
            const inputUser = form.querySelector('input[name="usuario"]').value;
            
            btn.disabled = true; btn.innerText = 'Entrando...'; msg.classList.add('hidden');
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());
            data.action = 'login';
            
            fetch(API_URL, {
                method: 'POST', 
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data)
            })
            .then(res => res.text())
            .then(text => {
                let json;
                try { json = JSON.parse(text); } catch(err) { throw new Error("Resposta inv√°lida"); }

                if(json.status === 'success') {
                    localStorage.setItem('rpps_token', json.token);
                    const usuarioFinal = json.usuario || inputUser; 
                    localStorage.setItem('rpps_user', usuarioFinal);
                    authToken = json.token; currentUser = usuarioFinal;
                    iniciarSistema();
                } else { 
                    msg.innerText = json.message || "Erro de conex√£o"; 
                    msg.classList.remove('hidden'); 
                }
            })
            .catch(e => {
                msg.innerText = "Erro: " + e.message; 
                msg.classList.remove('hidden'); 
            })
            .finally(() => { btn.disabled = false; btn.innerText = 'ENTRAR'; });
        }

        function logout(confirmLogout = true) { 
            if(confirmLogout && !confirm("Sair do sistema?")) return; 
            localStorage.removeItem('rpps_token'); 
            localStorage.removeItem('rpps_user');
            location.reload(); 
        }

        function mudarCompetencia(v) {
            if(!v) return;
            currentCompetencia = `${v.split('-')[1]}/${v.split('-')[0]}`;
            document.querySelectorAll('.current-comp').forEach(e => e.innerText = currentCompetencia);
            document.getElementById('mobile-comp').innerText = currentCompetencia;
            CACHE = {}; 
            const activeBtn = document.querySelector('.nav-btn.tab-active');
            if(activeBtn) {
                if(activeBtn.id === 'btn-graficos') carregarHistorico();
                else if(activeBtn.id === 'btn-margem') carregarMargem(); // Recarrega se estiver na margem
                else activeBtn.click();
            }
            preCarregarDados();
        }
    </script>
</body>
</html>
