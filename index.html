<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o RPPS - Controle Financeiro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { background-color: #2563eb; color: white; }
        
        /* Loading Overlay */
        #loadingOverlay { z-index: 60; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden-section { display: none; }
        input[type="month"] { position: relative; }
        input[type="month"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(1); }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 80;
            left: 50%; top: 30px; transform: translateX(-50%); font-size: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s, top 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }
        #toast.success { background-color: #10B981; }
        #toast.error { background-color: #EF4444; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10B981; }
        input:focus + .slider { box-shadow: 0 0 1px #10B981; }
        input:checked + .slider:before { transform: translateX(20px); }
        .switch-label { margin-left: 10px; font-size: 0.75rem; font-weight: bold; color: #6B7280; }
        input:checked ~ .switch-label { color: #10B981; }

        /* Modal Custom Confirm */
        #modal-confirm { z-index: 70; }
        
        /* Login Screen */
        #login-screen { z-index: 100; position: fixed; inset: 0; background-color: #1e3a8a; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- TELA DE LOGIN -->
    <div id="login-screen">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <i class="fas fa-university text-blue-800 text-5xl mb-2"></i>
                <h2 class="text-2xl font-bold text-gray-800">GestÃ£o RPPS</h2>
                <p class="text-gray-500 text-sm">Acesso Restrito</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">UsuÃ¡rio</label>
                    <input type="text" name="usuario" class="w-full p-3 border rounded bg-gray-50 focus:border-blue-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Senha</label>
                    <input type="password" name="senha" class="w-full p-3 border rounded bg-gray-50 focus:border-blue-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-blue-800 text-white font-bold py-3 rounded hover:bg-blue-900 transition duration-200">ENTRAR</button>
            </form>
            <div id="login-msg" class="mt-4 text-center text-red-500 text-sm hidden"></div>
        </div>
    </div>

    <!-- TOAST DE NOTIFICAÃ‡ÃƒO -->
    <div id="toast"><i class="fas fa-check-circle mr-2"></i><span id="toast-msg">Mensagem</span></div>
    
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden backdrop-blur-sm">
        <div class="loader mb-4"></div>
        <p class="text-blue-600 font-bold text-lg animate-pulse">Processando...</p>
    </div>

    <!-- MODAL CONFIRMAÃ‡ÃƒO PERSONALIZADO -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 border-t-4 border-blue-600">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i class="fas fa-question text-blue-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">ConfirmaÃ§Ã£o</h3>
                <p class="text-sm text-gray-500 mb-6" id="confirm-msg">Tem certeza?</p>
            </div>
            <div class="flex justify-center gap-3">
                <button onclick="closeConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium transition">Cancelar</button>
                <button onclick="closeConfirm(true)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-full md:w-64 bg-white shadow-lg flex flex-col z-20">
        <div class="p-6 bg-blue-800 text-white">
            <div class="flex justify-between items-start">
                <h1 class="text-lg font-bold mb-1"><i class="fas fa-university mr-2"></i>GestÃ£o RPPS</h1>
                <button onclick="logout()" class="text-xs text-blue-200 hover:text-white" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <p class="text-xs text-blue-200 mb-4" id="user-display">UsuÃ¡rio: ...</p>
            
            <label class="block text-xs font-bold text-blue-200 uppercase mb-1">CompetÃªncia (MÃªs/Ano)</label>
            <div class="relative">
                <input type="month" id="inputCompetencia" onchange="mudarCompetencia(this.value)" 
                       class="w-full p-3 bg-blue-700 border border-blue-600 rounded text-white font-bold text-center focus:outline-none focus:border-white shadow-inner cursor-pointer hover:bg-blue-600 transition-colors">
            </div>
            <p class="text-[10px] text-center mt-2 text-blue-300">Selecione para mudar o mÃªs</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <button onclick="showView('resumo')" id="btn-resumo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center tab-active">
                <i class="fas fa-chart-pie w-6"></i> Resumo
            </button>
            <button onclick="showView('conferencia')" id="btn-conferencia" class="nav-btn w-full text-left px-6 py-3 hover:bg-green-50 text-green-800 font-bold transition-colors flex items-center">
                <i class="fas fa-check-double w-6"></i> ConferÃªncia Pagtos
            </button>
            
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('pendencias')" id="btn-pendencias" class="nav-btn w-full text-left px-6 py-3 bg-red-50 text-red-700 font-bold border-l-4 border-red-500 hover:bg-red-100 transition-colors flex items-center">
                <i class="fas fa-exclamation-circle w-6"></i> PendÃªncias
            </button>
            <button onclick="showView('guias')" id="btn-guias" class="nav-btn w-full text-left px-6 py-3 hover:bg-purple-50 text-purple-800 font-medium transition-colors flex items-center">
                <i class="fas fa-landmark w-6"></i> Recolhimento Guias
            </button>

            <!-- CADASTROS -->
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('folha')" id="btn-folha" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-users w-6"></i> Folha Pagamento
            </button>
            <button onclick="showView('decimo')" id="btn-decimo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-gift w-6"></i> 13Âº SalÃ¡rio
            </button>
            <button onclick="showView('outros')" id="btn-outros" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-exchange-alt w-6"></i> Outros Bancos
            </button>
            <button onclick="showView('consignados')" id="btn-consignados" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-hand-holding-usd w-6"></i> Consignados
            </button>
            <button onclick="showView('adm')" id="btn-adm" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-contract w-6"></i> Assessorias e Desp.
            </button>
            
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('imposto')" id="btn-imposto" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-invoice-dollar w-6"></i> Imposto de Renda
            </button>
        </nav>
    </aside>

    <!-- ÃREA PRINCIPAL -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100 relative">
        <header class="bg-blue-800 text-white shadow-sm p-4 flex justify-between items-center md:hidden">
            <span class="font-bold text-lg">RPPS</span>
            <span id="mobile-comp" class="text-sm font-bold bg-blue-700 px-2 py-1 rounded">--/----</span>
        </header>

        <!-- CONTEÃšDO SCROLLÃVEL -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainContent">
            
            <!-- VIEW: RESUMO -->
            <div id="view-resumo" class="view-section">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-sm text-gray-500">CompetÃªncia <span class="current-comp font-bold text-blue-600">--/----</span></p>
                    </div>
                    <button onclick="carregarResumo()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                
                <!-- GRID DE CARDS REORGANIZADO -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Folha LÃ­quida (Destaque) -->
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-600 lg:col-span-2 relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-4 opacity-10"><i class="fas fa-users text-6xl text-blue-600"></i></div>
                        <p class="text-sm text-gray-500 uppercase font-bold tracking-wide">Folha LÃ­quida (Total)</p>
                        <h3 class="text-4xl font-bold text-gray-800 mt-2" id="dash-total-folha">R$ 0,00</h3>
                        <div class="mt-4 flex items-center text-sm text-blue-600 bg-blue-50 w-fit px-3 py-1 rounded-full">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span id="dash-sub-folha">Carregando...</span>
                        </div>
                    </div>

                    <!-- Bradesco Estimado -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">LÃ­quido Bradesco (Est.)</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-bradesco">R$ 0,00</h3>
                                <p class="text-[10px] text-gray-400 mt-1 font-semibold">(Folha LÃ­quida - Outros Bancos)</p>
                            </div>
                            <div class="text-green-500"><i class="fas fa-money-check-alt text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Outros Bancos -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Outros Bancos</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-outros">R$ 0,00</h3>
                            </div>
                            <div class="text-orange-500"><i class="fas fa-university text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Consignados -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Consignados</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-consig">R$ 0,00</h3>
                            </div>
                            <div class="text-purple-500"><i class="fas fa-hand-holding-usd text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Assessorias -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Assessorias e Desp.</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-adm">R$ 0,00</h3>
                            </div>
                            <div class="text-indigo-500"><i class="fas fa-file-invoice-dollar text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Imposto de Renda -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-gray-600">
                        <div class="flex justify-between">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Imposto de Renda</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-imposto">R$ 0,00</h3>
                            </div>
                            <div class="text-gray-500"><i class="fas fa-landmark text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Recolhimento Guias -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-800">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Recolhimento Guias</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-recolhimento-pago">R$ 0,00</h3>
                                <p class="text-xs text-gray-400 mt-1">De: <span id="dash-recolhimento-devido">R$ 0,00</span> (Devido)</p>
                            </div>
                            <div class="text-purple-800"><i class="fas fa-landmark text-2xl"></i></div>
                        </div>
                    </div>
                </div>

                <!-- ConferÃªncia -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">ConferÃªncia da Folha</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <tbody class="divide-y divide-gray-100">
                                <tr>
                                    <td class="px-4 py-3 font-medium">Total (Folha + 13Âº)</td>
                                    <td class="px-4 py-3 text-right font-bold text-blue-600" id="conf-folha">R$ 0,00</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">(-) Outros Bancos</td>
                                    <td class="px-4 py-3 text-right text-red-500" id="conf-outros">R$ 0,00</td>
                                </tr>
                                <tr class="bg-green-50">
                                    <td class="px-4 py-3 font-bold">(=) Previsto Bradesco</td>
                                    <td class="px-4 py-3 text-right font-bold text-green-700" id="conf-bradesco">R$ 0,00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: CONFERÃŠNCIA PAGAMENTOS -->
            <div id="view-conferencia" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-green-800"><i class="fas fa-check-double mr-2"></i>ConferÃªncia de Pagamentos</h2>
                    <button onclick="carregarConferencia()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-4 text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i> Marque o que jÃ¡ foi pago. Itens desligados constarÃ£o como <strong>Pendentes</strong>.
                </div>
                <div id="conferencia-container" class="space-y-6"></div>
                <div id="empty-conferencia" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhum lanÃ§amento neste mÃªs.</div>
            </div>

            <!-- VIEW: PENDÃŠNCIAS ORGANIZADA -->
            <div id="view-pendencias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>PendÃªncias em Aberto</h2>
                    <button onclick="carregarPendencias()" class="text-sm text-gray-600 hover:text-gray-900"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>
                
                <div id="pendencias-container" class="space-y-6">
                    <!-- JS vai inserir os grupos aqui -->
                </div>
                <div id="empty-pendencias" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhuma pendÃªncia encontrada! ðŸŽ‰</div>
            </div>

            <!-- VIEW: RECOLHIMENTO GUIAS -->
            <div id="view-guias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-purple-800"><i class="fas fa-landmark mr-2"></i>Recolhimento de Guias</h2>
                        <p class="text-xs text-gray-500">Controle de repasses da Prefeitura</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="abrirModal('modal-config-guia', 'adicionarTipoGuia')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm"><i class="fas fa-cog"></i> Configurar Tipos</button>
                        <button onclick="carregarTiposParaSelect(); abrirModal('modal-guia', 'adicionarGuiaObrigacao')" class="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700"><i class="fas fa-plus"></i> Nova Guia</button>
                    </div>
                </div>
                
                <div id="container-guias" class="space-y-6">
                    <!-- Cards de Guias serÃ£o inseridos aqui via JS -->
                </div>
                <div id="empty-guias" class="p-8 text-center text-gray-500 hidden bg-white rounded-xl shadow-sm">Nenhuma guia lanÃ§ada nesta competÃªncia.</div>
            </div>

            <!-- VIEW: IMPOSTO DE RENDA -->
            <div id="view-imposto" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Imposto de Renda (Retido)</h2>
                    <button onclick="abrirModal('modal-imposto', 'adicionarImpostoRenda')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow"><i class="fas fa-plus mr-2"></i>LanÃ§ar IR</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-600 text-white uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Origem</th>
                                <th class="px-6 py-3">DescriÃ§Ã£o</th>
                                <th class="px-6 py-3 text-right">Valor</th>
                                <th class="px-6 py-3">Obs</th>
                                <th class="px-6 py-3 text-center">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-imposto" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-imposto" class="p-8 text-center text-gray-500 hidden">Nenhum lanÃ§amento.</div>
                </div>
            </div>

            <!-- DEMAIS VIEWS (CADASTROS) -->
            <div id="view-folha" class="view-section hidden-section"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Folha</h2><button onclick="abrirModal('modal-folha', 'adicionarFolha')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-folha"></tbody></table><div id="empty-folha" class="p-4 text-center hidden">Vazio</div></div></div>
            <div id="view-decimo" class="view-section hidden-section"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold text-blue-800">13Âº SalÃ¡rio</h2><button onclick="abrirModal('modal-decimo', 'adicionarDecimo')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div><div class="bg-white rounded shadow overflow-hidden border border-blue-100"><table class="w-full text-sm text-left"><thead class="bg-blue-50 text-blue-700 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-decimo"></tbody></table><div id="empty-decimo" class="p-4 text-center hidden">Vazio</div></div></div>
            <div id="view-outros" class="view-section hidden-section"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Outros Bancos</h2><div class="flex gap-2"><button onclick="confirmarImportacao('OUTROS_BANCOS')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm"><i class="fas fa-copy"></i> Copiar MÃªs Anterior</button><button onclick="abrirModal('modal-outros', 'adicionarOutrosBancos')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Nome</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Banco</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-outros"></tbody></table><div id="empty-outros" class="p-4 text-center hidden">Vazio</div></div></div>
            <div id="view-consignados" class="view-section hidden-section"><div class="flex justify-between mb-4"><h2 class="text-2xl font-bold">Consignados</h2><button onclick="abrirModal('modal-consignados', 'adicionarConsignado')" class="bg-blue-600 text-white px-4 py-2 rounded">Adicionar</button></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3">Obs</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-consignados"></tbody></table><div id="empty-consignados" class="p-4 text-center hidden">Vazio</div></div></div>
            <div id="view-adm" class="view-section hidden-section"><div class="mb-8"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold">Assessorias e Desp.</h3><div class="flex gap-2"><button onclick="confirmarImportacao('PAGAMENTOS_RECORRENTES')" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm"><i class="fas fa-copy"></i> Copiar MÃªs Anterior</button><button onclick="abrirModal('modal-recorrentes', 'adicionarRecorrente')" class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs shadow"><i class="fas fa-plus mr-1"></i> Adicionar</button></div></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">DescriÃ§Ã£o</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-recorrentes"></tbody></table><div id="empty-recorrentes" class="p-4 text-center hidden">Vazio</div></div></div><div><div class="flex justify-between mb-4"><h3 class="text-xl font-bold">Outras Despesas</h3><button onclick="abrirModal('modal-eventuais', 'adicionarOutroPagamento')" class="bg-purple-600 text-white px-3 py-1.5 rounded">Adicionar</button></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-gray-50 text-gray-600 uppercase text-xs"><tr><th class="px-6 py-3">DescriÃ§Ã£o</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">AÃ§Ãµes</th></tr></thead><tbody id="lista-eventuais"></tbody></table><div id="empty-eventuais" class="p-4 text-center hidden">Vazio</div></div></div></div>
        </div>
    </main>

    <!-- MODAIS -->

    <!-- Modal Imposto (NOVO) -->
    <div id="modal-imposto" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">LanÃ§ar Imposto de Renda</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarImpostoRenda"><input type="hidden" name="sheetKey" value="IMPOSTO"><div class="mb-4"><label class="text-xs font-bold text-gray-500">Origem</label><select name="tipo" class="w-full border p-2 rounded"><option>Folha Pagamento</option><option>Nota Fiscal</option></select></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">DescriÃ§Ã£o (Opcional)</label><input name="descricao" class="w-full border p-2 rounded" placeholder="Ex: NF 123 - Empresa X"></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Valor Retido</label><input name="valor" class="money-mask w-full border p-2 rounded" required></div><div class="mb-4"><label class="text-xs font-bold text-gray-500">Obs</label><input name="obs" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="toggleModal('modal-imposto')" class="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button></div></form></div></div>

    <!-- Modais Existentes -->
    <div id="modal-folha" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Folha</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarFolha"><input type="hidden" name="sheetKey" value="FOLHA"><select name="tipo" class="w-full border p-2 mb-2"><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor" required><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-decimo" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-blue-600"><h3 class="font-bold text-lg mb-4 text-blue-800">13Âº</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarDecimo"><input type="hidden" name="sheetKey" value="DECIMO"><select name="tipo" class="w-full border p-2 mb-2"><option>Aposentados</option><option>Pensionistas</option><option>Comissionados</option></select><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor" required><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-outros" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Outros</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutrosBancos"><input type="hidden" name="sheetKey" value="OUTROS_BANCOS"><input name="nome" class="w-full border p-2 mb-2" placeholder="Nome"><select name="tipo" class="w-full border p-2 mb-2"><option>Aposentado</option><option>Pensionista</option><option>Comissionado</option></select><input name="banco" class="w-full border p-2 mb-2" placeholder="Banco"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-consignados" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Consignado</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarConsignado"><input type="hidden" name="sheetKey" value="CONSIGNADOS"><input name="tipo" class="w-full border p-2 mb-2" placeholder="Tipo/Banco"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-recorrentes" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Assessoria</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarRecorrente"><input type="hidden" name="sheetKey" value="RECORRENTES"><input name="descricao" class="w-full border p-2 mb-2" placeholder="DescriÃ§Ã£o"><select name="tipo" class="w-full border p-2 mb-2"><option>Assessoria</option><option>ServiÃ§o</option></select><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>
    
    <div id="modal-eventuais" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4">Eventual</h3><form onsubmit="handleSubmit(event)"><input type="hidden" name="id"><input type="hidden" name="action_type" value="adicionarOutroPagamento"><input type="hidden" name="sheetKey" value="OUTROS_PGTOS"><input name="descricao" class="w-full border p-2 mb-2" placeholder="DescriÃ§Ã£o"><input name="valor" class="money-mask w-full border p-2 mb-2" placeholder="Valor"><input name="obs" class="w-full border p-2 mb-2" placeholder="Obs"><div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Salvar</button></div></form></div></div>

    <!-- MODAIS DE GUIA (NOVOS) -->
    <!-- Configurar Tipos -->
    <div id="modal-config-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="font-bold text-lg mb-4">Novo Tipo de Guia</h3>
            <form onsubmit="handleSubmit(event)">
                <input type="hidden" name="id">
                <input type="hidden" name="action_type" value="adicionarTipoGuia">
                <input type="hidden" name="sheetKey" value="CONFIG_GUIAS">
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">Nome da Guia</label>
                    <input name="nome" class="w-full border p-2 rounded uppercase" placeholder="Ex: IPSM SAÃšDE" required>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-config-guia')" class="px-4 py-2 text-gray-600">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LanÃ§ar ObrigaÃ§Ã£o (Guia) -->
    <div id="modal-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-purple-600">
            <h3 class="font-bold text-lg mb-4 text-purple-800">LanÃ§ar Guia (ObrigaÃ§Ã£o)</h3>
            <form onsubmit="handleSubmit(event)">
                <input type="hidden" name="id">
                <input type="hidden" name="action_type" value="adicionarGuiaObrigacao">
                <input type="hidden" name="sheetKey" value="GUIAS">
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">Tipo de Guia</label>
                    <select name="tipo" id="select-tipo-guia" class="w-full border p-2 rounded" required>
                        <!-- Preenchido via JS -->
                    </select>
                </div>
                
                <!-- Valores FlexÃ­veis -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Valor Principal</label>
                        <input name="valorPrincipal" class="money-mask w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Valor DÃ©cimo</label>
                        <input name="valorDecimo" class="money-mask w-full border p-2 rounded">
                    </div>
                </div>
                
                <!-- Campos extras para Piso Enfermagem -->
                <div id="extra-fields-guia" class="hidden grid grid-cols-2 gap-4 mb-4 bg-gray-50 p-2 rounded">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Parte Segurado</label>
                        <input name="valorSegurado" class="money-mask w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Parte Patronal</label>
                        <input name="valorPatronal" class="money-mask w-full border p-2 rounded">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">ObservaÃ§Ã£o</label>
                    <input name="obs" class="w-full border p-2 rounded">
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-guia')" class="px-4 py-2 text-gray-600">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LanÃ§ar Pagamento (Baixa) -->
    <div id="modal-pagamento-guia" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="font-bold text-lg mb-4 text-green-700">Baixar Pagamento</h3>
            <form onsubmit="handleSubmit(event)">
                <input type="hidden" name="action_type" value="adicionarPagamentoGuia">
                <input type="hidden" name="idGuia" id="input-id-guia-ref">
                <input type="hidden" name="id">
                
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">Data do Pagamento</label>
                    <input type="date" name="dataPagto" class="w-full border p-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">Valor Pago</label>
                    <input name="valorPago" class="money-mask w-full border p-2 rounded" required>
                </div>
                <div class="mb-4">
                    <label class="text-xs font-bold text-gray-500">Obs (Comprovante/Lote)</label>
                    <input name="obs" class="w-full border p-2 rounded">
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-pagamento-guia')" class="px-4 py-2 text-gray-600">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Baixar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwt5wH_wT65wfXyaBc78YK4ZBHcCi7zFATSQRk6yytCTHFlqCLs1Gc7JSS395aYNUmR/exec";
        let currentCompetencia = "";
        let authToken = localStorage.getItem('rpps_token');
        let currentUser = localStorage.getItem('rpps_user');
        
        let confirmCallback = null;

        // --- INICIALIZAÃ‡ÃƒO E LOGIN ---
        window.onload = async function() {
            if(authToken) {
                const res = await fetch(`${API_URL}?action=verificarToken&token=${authToken}`);
                const json = await res.json();
                if(json.status === 'success') {
                    currentUser = json.usuario;
                    iniciarSistema();
                    return;
                }
            }
            document.getElementById('login-screen').style.display = 'flex';
        };

        function iniciarSistema() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('user-display').innerText = `UsuÃ¡rio: ${currentUser}`;
            const d = new Date();
            const v = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('inputCompetencia').value = v;
            mudarCompetencia(v);
            setupMoneyMask();
            document.getElementById('select-tipo-guia').addEventListener('change', function() {
                const isPiso = this.value.includes('ENFERMAGEM');
                document.getElementById('extra-fields-guia').classList.toggle('hidden', !isPiso);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            const msg = document.getElementById('login-msg');
            btn.disabled = true; btn.innerText = 'Entrando...'; msg.classList.add('hidden');
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());
            data.action = 'login';
            try {
                const res = await fetch(API_URL, {method: 'POST', body: JSON.stringify(data)});
                const json = await res.json();
                if(json.status === 'success') {
                    localStorage.setItem('rpps_token', json.token);
                    localStorage.setItem('rpps_user', json.usuario);
                    authToken = json.token; currentUser = json.usuario;
                    iniciarSistema();
                } else { msg.innerText = json.message; msg.classList.remove('hidden'); }
            } catch(e) { msg.innerText = "Erro de conexÃ£o"; msg.classList.remove('hidden'); } finally { btn.disabled = false; btn.innerText = 'ENTRAR'; }
        }

        function logout() { if(!confirm("Sair do sistema?")) return; localStorage.removeItem('rpps_token'); location.reload(); }

        // --- SISTEMA ---
        function mudarCompetencia(v) {
            if(!v) return;
            currentCompetencia = `${v.split('-')[1]}/${v.split('-')[0]}`;
            document.querySelectorAll('.current-comp').forEach(e => e.innerText = currentCompetencia);
            document.querySelector('.nav-btn.tab-active')?.click();
        }

        function showView(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('tab-active'));
            document.getElementById(`view-${view}`).classList.remove('hidden-section');
            document.getElementById(`btn-${view}`).classList.add('tab-active');
            
            if(view === 'resumo') carregarResumo();
            else if(view === 'conferencia') carregarConferencia();
            else if(view === 'folha') carregarLista('FOLHA_PAGAMENTO', 'lista-folha', 'empty-folha', renderRowFolha);
            else if(view === 'imposto') carregarLista('IMPOSTO_RENDA', 'lista-imposto', 'empty-imposto', renderRowImposto);
            else if(view === 'outros') carregarLista('OUTROS_BANCOS', 'lista-outros', 'empty-outros', renderRowOutros);
            else if(view === 'consignados') carregarLista('CONSIGNADOS', 'lista-consignados', 'empty-consignados', renderRowConsig);
            else if(view === 'adm') {
                carregarLista('PAGAMENTOS_RECORRENTES', 'lista-recorrentes', 'empty-recorrentes', renderRowRecorrente);
                carregarLista('OUTROS_PAGAMENTOS', 'lista-eventuais', 'empty-eventuais', renderRowEventual);
            }
            else if(view === 'pendencias') carregarPendencias();
            else if(view === 'decimo') carregarLista('DECIMO_TERCEIRO', 'lista-decimo', 'empty-decimo', renderRowDecimo);
            else if(view === 'guias') carregarGuias();
        }

        // --- LÃ“GICA DE GUIAS (NOVA) ---
        async function carregarGuias() {
            setLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getGuiasDetalhadas&competencia=${currentCompetencia}&token=${authToken}`);
                const json = await res.json();
                const container = document.getElementById('container-guias');
                const empty = document.getElementById('empty-guias');
                container.innerHTML = '';

                if(json.status === 'success' && json.data.length > 0) {
                    empty.classList.add('hidden');
                    json.data.forEach(g => {
                        const pendente = g.totalDevido - g.totalPago;
                        const statusColor = pendente <= 0.01 ? 'bg-green-100 border-green-500' : 'bg-white border-purple-200';
                        const statusText = pendente <= 0.01 ? '<span class="text-green-600 font-bold">QUITADO</span>' : `<span class="text-red-600 font-bold">Resta: ${formatCurrency(pendente)}</span>`;
                        let pgtosHtml = '';
                        if(g.pagamentos && g.pagamentos.length > 0) {
                            pgtosHtml = `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500"><p class="font-bold mb-1">HistÃ³rico de Pagamentos:</p>`;
                            g.pagamentos.forEach(p => {
                                pgtosHtml += `<div class="flex justify-between"><span>${p.data.split('T')[0]} - ${p.obs}</span> <span>${formatCurrency(p.valor)}</span></div>`;
                            });
                            pgtosHtml += `</div>`;
                        }
                        let detalhesValores = `Princ: ${formatCurrency(g.vPrincipal)} | 13Âº: ${formatCurrency(g.vDecimo)}`;
                        if(g.tipo.includes('ENFERMAGEM')) detalhesValores = `Seg: ${formatCurrency(g.vSegurado)} | Patr: ${formatCurrency(g.vPatronal)}`;

                        container.innerHTML += `
                            <div class="rounded-lg border-l-4 shadow-sm p-4 ${statusColor}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-gray-800 text-lg">${g.tipo}</h3>
                                        <p class="text-xs text-gray-500 font-mono">${detalhesValores}</p>
                                        <div class="mt-2 text-sm">
                                            Devido: <strong>${formatCurrency(g.totalDevido)}</strong> <span class="mx-2 text-gray-300">|</span> 
                                            Pago: <strong>${formatCurrency(g.totalPago)}</strong>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        ${statusText}
                                        <div class="mt-2 flex gap-1 justify-end">
                                            <button onclick="abrirModalPagamento('${g.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 shadow" title="Baixar Pagamento"><i class="fas fa-check"></i> Pagar</button>
                                            <button onclick="editarGuia('${g.id}', '${g.tipo}', '${g.vPrincipal}', '${g.vDecimo}', '${g.vSegurado}', '${g.vPatronal}', '${g.obs}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs hover:bg-blue-200"><i class="fas fa-pencil-alt"></i></button>
                                            <button onclick="excluir('GUIAS', '${g.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-200"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                                ${pgtosHtml}
                            </div>
                        `;
                    });
                } else { empty.classList.remove('hidden'); }
            } catch(e) { showToast('Erro ao carregar guias', 'error'); } finally { setLoading(false); }
        }

        async function carregarTiposParaSelect() {
            const res = await fetch(`${API_URL}?action=getConfigGuias&token=${authToken}`);
            const json = await res.json();
            const select = document.getElementById('select-tipo-guia');
            select.innerHTML = '';
            if(json.status === 'success') { json.data.forEach(t => { select.innerHTML += `<option value="${t.nome}">${t.nome}</option>`; }); }
        }
        function abrirModalPagamento(idGuia) { document.getElementById('input-id-guia-ref').value = idGuia; const hoje = new Date().toISOString().split('T')[0]; document.querySelector('#modal-pagamento-guia input[type="date"]').value = hoje; toggleModal('modal-pagamento-guia'); }
        function editarGuia(id, tipo, vPrinc, vDec, vSeg, vPatr, obs) { abrirModal('modal-guia', 'adicionarGuiaObrigacao', { id: id, tipo: tipo, valorPrincipal: vPrinc, valorDecimo: vDec, valorSegurado: vSeg, valorPatronal: vPatr, obs: obs }); const select = document.getElementById('select-tipo-guia'); select.value = tipo; select.dispatchEvent(new Event('change')); }

        // --- SISTEMA DE CONFIRMAÃ‡ÃƒO ---
        function confirmarImportacao(sheetTarget) { openConfirm(`Copiar registros do mÃªs anterior para ${currentCompetencia}?`, async () => { setLoading(true); try { const res = await fetch(API_URL, { method:'POST', body: JSON.stringify({action:'importarMesAnterior', sheetTarget, competenciaAtual:currentCompetencia, usuarioLog:currentUser})}); const json = await res.json(); showToast(json.status==='success'?'Sucesso!':'Erro', json.status); if(json.status==='success') document.querySelector('.nav-btn.tab-active').click(); } catch(e) { showToast('Erro conexÃ£o', 'error'); } finally { setLoading(false); } }); }
        function openConfirm(msg, callback) { document.getElementById('confirm-msg').innerText = msg; document.getElementById('modal-confirm').classList.remove('hidden'); confirmCallback = callback; }
        function closeConfirm(yes) { document.getElementById('modal-confirm').classList.add('hidden'); if(yes && confirmCallback) confirmCallback(); confirmCallback = null; }
        async function excluir(sheetKey, id) { openConfirm("Excluir este registro?", async () => { setLoading(true); await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'excluirRegistro', sheetName:sheetKey, id, competencia:currentCompetencia, usuarioLog:currentUser})}); showToast('ExcluÃ­do', 'success'); if(sheetKey === 'GUIAS') carregarGuias(); else document.querySelector('.nav-btn.tab-active').click(); setLoading(false); }); }

        // --- RENDERERS GERAIS ---
        function renderRowImposto(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-bold text-gray-700">${row[1]}</td><td class="p-3">${row[2]}</td><td class="p-3 text-right font-bold">${formatCurrency(row[3])}</td><td class="p-3 text-xs text-gray-500">${row[4]}</td><td class="p-3 text-center">${getActions('IMPOSTO', row, 6)}</td></tr>`; }
        function renderRowFolha(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${row[1]}</td><td class="p-3 text-right font-bold text-blue-600">${formatCurrency(row[2])}</td><td class="p-3 text-xs">${row[3]}</td><td class="p-3 text-center">${getActions('FOLHA', row, 6)}</td></tr>`; }
        function renderRowDecimo(row) { return `<tr class="border-b hover:bg-blue-50 border-blue-100"><td class="p-3 font-medium text-blue-900">${row[1]}</td><td class="p-3 text-right font-bold text-blue-700">${formatCurrency(row[2])}</td><td class="p-3 text-xs text-blue-500">${row[3]}</td><td class="p-3 text-center">${getActions('DECIMO', row, 6)}</td></tr>`; }
        function renderRowOutros(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${row[1]}</td><td class="p-3 text-xs">${row[2]}</td><td class="p-3">${row[3]}</td><td class="p-3 text-right font-bold text-orange-600">${formatCurrency(row[4])}</td><td class="p-3 text-xs">${row[5]}</td><td class="p-3 text-center">${getActions('OUTROS_BANCOS', row, 8)}</td></tr>`; }
        function renderRowConsig(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${row[1]}</td><td class="p-3 text-right font-bold text-purple-600">${formatCurrency(row[2])}</td><td class="p-3 text-xs">${row[3]}</td><td class="p-3 text-center">${getActions('CONSIGNADOS', row, 6)}</td></tr>`; }
        function renderRowRecorrente(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${row[1]}<br><span class="text-xs text-gray-400">${row[2]}</span></td><td class="p-3 text-right font-bold">${formatCurrency(row[3])}</td><td class="p-3 text-center">${getActions('RECORRENTES', row, 6)}</td></tr>`; }
        function renderRowEventual(row) { return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${row[1]}</td><td class="p-3 text-right font-bold">${formatCurrency(row[2])}</td><td class="p-3 text-center">${getActions('OUTROS_PGTOS', row, 5)}</td></tr>`; }

        function getActions(key, row, idIdx) {
            const id = row[idIdx]; const safe = s => String(s).replace(/'/g,"\\'").replace(/"/g,"&quot;"); let params = "{}";
            if(key==='IMPOSTO') params=`{id:'${id}', tipo:'${safe(row[1])}', descricao:'${safe(row[2])}', valor:'${safe(row[3])}', obs:'${safe(row[4])}'}`;
            if(key==='FOLHA') params=`{id:'${id}', tipo:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[3])}'}`;
            if(key==='DECIMO') params=`{id:'${id}', tipo:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[3])}'}`;
            if(key==='CONSIGNADOS') params=`{id:'${id}', tipo:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[3])}'}`;
            if(key==='OUTROS_BANCOS') params=`{id:'${id}', nome:'${safe(row[1])}', tipo:'${safe(row[2])}', banco:'${safe(row[3])}', valor:'${safe(row[4])}', obs:'${safe(row[5])}'}`;
            if(key==='RECORRENTES') params=`{id:'${id}', descricao:'${safe(row[1])}', tipo:'${safe(row[2])}', valor:'${safe(row[3])}', obs:'${safe(row[5])}'}`;
            if(key==='OUTROS_PGTOS') params=`{id:'${id}', descricao:'${safe(row[1])}', valor:'${safe(row[2])}', obs:'${safe(row[4])}'}`;
            let modal = 'modal-folha'; let action = 'adicionarFolha';
            if(key==='IMPOSTO') { modal='modal-imposto'; action='adicionarImpostoRenda'; }
            else if(key==='DECIMO') { modal='modal-decimo'; action='adicionarDecimo'; }
            else if(key==='CONSIGNADOS') { modal='modal-consignados'; action='adicionarConsignado'; }
            else if(key==='OUTROS_BANCOS') { modal='modal-outros'; action='adicionarOutrosBancos'; }
            else if(key==='RECORRENTES') { modal='modal-recorrentes'; action='adicionarRecorrente'; }
            else if(key==='OUTROS_PGTOS') { modal='modal-eventuais'; action='adicionarOutroPagamento'; }
            return `<button onclick="abrirModal('${modal}','${action}',${params})" class="text-blue-500 mr-2"><i class="fas fa-pencil-alt"></i></button><button onclick="excluir('${key}','${id}')" class="text-red-400"><i class="fas fa-trash"></i></button>`;
        }

        // --- SUBMIT ---
        async function handleSubmit(e) { e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries()); data.action = data.id ? 'editarRegistro' : data.action_type; data.competencia = currentCompetencia; data.usuarioLog = currentUser; toggleModal(e.target.closest('div[id^="modal"]').id); setLoading(true); try { const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); const json = await res.json(); showToast(json.status==='success'?'Salvo!':'Erro', json.status); if(data.action_type === 'adicionarGuiaObrigacao' || data.action_type === 'adicionarPagamentoGuia') { carregarGuias(); } else { document.querySelector('.nav-btn.tab-active').click(); } } catch(e) { showToast('Erro', 'error'); } finally { setLoading(false); } }
        async function carregarResumo() { const res = await fetch(`${API_URL}?action=getResumoMensal&competencia=${currentCompetencia}&token=${authToken}`); const json = await res.json(); if(json.status === 'success') { document.getElementById('dash-total-folha').innerText = formatCurrency(json.folha.total_geral); document.getElementById('dash-sub-folha').innerText = `Normal: ${formatCurrency(json.folha.total_normal)} | 13Âº: ${formatCurrency(json.folha.total_decimo)}`; document.getElementById('dash-total-outros').innerText = formatCurrency(json.bancos.outros); document.getElementById('dash-total-imposto').innerText = formatCurrency(json.imposto.total); document.getElementById('dash-total-bradesco').innerText = formatCurrency(json.bancos.bradesco); document.getElementById('dash-total-consig').innerText = formatCurrency(json.consignados.total); document.getElementById('dash-total-adm').innerText = formatCurrency(json.administrativo.total); document.getElementById('dash-recolhimento-pago').innerText = formatCurrency(json.recolhimento.pago); document.getElementById('dash-recolhimento-devido').innerText = formatCurrency(json.recolhimento.devido); document.getElementById('conf-folha').innerText = formatCurrency(json.folha.total_geral); document.getElementById('conf-outros').innerText = formatCurrency(json.bancos.outros); document.getElementById('conf-bradesco').innerText = formatCurrency(json.bancos.bradesco); } }
        async function carregarLista(sheet, tbodyId, emptyId, renderFn) { setLoading(true); const res = await fetch(`${API_URL}?action=getList&sheet=${sheet}&competencia=${currentCompetencia}&token=${authToken}`); const json = await res.json(); const tbody = document.getElementById(tbodyId); tbody.innerHTML = ''; if(json.data && json.data.length > 0) { document.getElementById(emptyId).classList.add('hidden'); json.data.forEach(r => tbody.innerHTML += renderFn(r)); } else { document.getElementById(emptyId).classList.remove('hidden'); } setLoading(false); }

        async function carregarConferencia() {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getConferencia&competencia=${currentCompetencia}&token=${authToken}`);
                const json = await response.json();
                const container = document.getElementById('conferencia-container');
                const empty = document.getElementById('empty-conferencia');
                container.innerHTML = '';
                if(json.status === 'success' && json.data.length > 0) {
                    empty.classList.add('hidden');
                    const grupos = {};
                    json.data.forEach(item => { if(!grupos[item.grupo]) grupos[item.grupo] = []; grupos[item.grupo].push(item); });
                    for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                        let rows = '';
                        itens.forEach(item => {
                            const isPago = item.status === 'Pago';
                            const switchHtml = `<label class="switch"><input type="checkbox" ${isPago ? 'checked' : ''} onchange="togglePagamento('${item.id}', '${item.origem}', this)"><span class="slider"></span></label><span class="switch-label">${isPago ? 'PAGO' : 'PENDENTE'}</span>`;
                            rows += `<tr class="hover:bg-gray-50 border-b last:border-0 ${isPago ? 'bg-green-50' : ''}"><td class="px-6 py-4 text-xs font-bold uppercase text-gray-500 w-1/4">${item.origem}</td><td class="px-6 py-4 font-medium ${isPago ? 'text-gray-400 line-through' : 'text-gray-900'} w-1/3">${item.descricao}</td><td class="px-6 py-4 text-right font-bold w-1/4">${formatCurrency(item.valor)}</td><td class="px-6 py-4 text-center flex items-center justify-center">${switchHtml}</td></tr>`;
                        });
                        container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div class="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-700">${nomeGrupo}</h3><span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">${itens.length}</span></div><table class="w-full text-sm text-left"><tbody class="divide-y divide-gray-100">${rows}</tbody></table></div>`;
                    }
                } else { empty.classList.remove('hidden'); }
            } catch(e) { showToast('Erro lista', 'error'); } finally { setLoading(false); }
        }

        async function togglePagamento(id, origem, checkbox) { checkbox.disabled = true; const novoStatus = checkbox.checked ? 'Pago' : 'Pendente'; const label = checkbox.parentElement.nextElementSibling; label.innerText = novoStatus === 'Pago' ? 'PAGO' : 'PENDENTE'; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'atualizarStatusPagamento', id, origem, novoStatus, usuarioLog: currentUser }) }); const tr = checkbox.closest('tr'); const desc = tr.querySelector('td:nth-child(2)'); if(novoStatus === 'Pago') { tr.classList.add('bg-green-50'); desc.classList.add('text-gray-400', 'line-through'); desc.classList.remove('text-gray-900'); } else { tr.classList.remove('bg-green-50'); desc.classList.remove('text-gray-400', 'line-through'); desc.classList.add('text-gray-900'); } } catch(e) { checkbox.checked = !checkbox.checked; showToast('Erro', 'error'); } finally { checkbox.disabled = false; } }
        function abrirModal(id, action, editData=null) { const m = document.getElementById(id); const f = m.querySelector('form'); if (!f) return; f.reset(); const actionInput = f.querySelector('[name="action_type"]'); if (actionInput) actionInput.value = action; const idInput = f.querySelector('[name="id"]'); if (idInput) idInput.value = ""; const titleEl = m.querySelector('h3'); if (titleEl) titleEl.innerText = titleEl.innerText.replace('Editar', 'Adicionar'); if (editData) { if (idInput) idInput.value = editData.id; for (let k in editData) { const input = f.querySelector(`[name="${k}"]`); if (input) { input.value = k.includes('valor') ? formatCurrency(editData[k]) : editData[k]; } } if (titleEl) titleEl.innerText = titleEl.innerText.replace('Adicionar', 'Editar'); } toggleModal(id); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function setLoading(act) { document.getElementById('loadingOverlay').classList.toggle('hidden', !act); }
        function formatCurrency(v) { return parseFloat(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function showToast(msg, type) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg; t.className=type; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function setupMoneyMask() { document.querySelectorAll('.money-mask').forEach(i => i.addEventListener('input', e => { let v = e.target.value.replace(/\D/g,""); v=(v/100).toFixed(2)+""; e.target.value="R$ "+v.replace(".",",").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."); })); }
        
        async function carregarPendencias() {
             setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getPendencias&token=${authToken}`);
                const json = await response.json();
                const container = document.getElementById('pendencias-container');
                const emptyDiv = document.getElementById('empty-pendencias');
                container.innerHTML = '';
                if(json.status === 'success' && json.data.length > 0) {
                    emptyDiv.classList.add('hidden');
                    const grupos = {};
                    json.data.forEach(item => { const grp = item.grupo || 'Geral'; if(!grupos[grp]) grupos[grp] = []; grupos[grp].push(item); });
                    for (const [nomeGrupo, itens] of Object.entries(grupos)) {
                        let rows = '';
                        itens.forEach(row => {
                            let badgeClass = 'bg-red-100 text-red-600'; if(row.status === 'A Receber') badgeClass = 'bg-purple-100 text-purple-600';
                            rows += `<tr class="hover:bg-red-50 border-b border-red-100 last:border-0"><td class="px-6 py-3 text-sm font-bold text-gray-700 w-1/6">${row.competencia}</td><td class="px-6 py-3 text-xs uppercase text-gray-500 w-1/6">${row.origem}</td><td class="px-6 py-3 text-sm text-gray-800 font-medium w-1/3">${row.descricao}</td><td class="px-6 py-3 text-right font-bold text-gray-800 w-1/6">${formatCurrency(row.valor)}</td><td class="px-6 py-3 text-center w-1/6"><span class="${badgeClass} font-bold text-xs px-2 py-1 rounded">${row.status}</span></td></tr>`;
                        });
                        container.innerHTML += `<div class="bg-white rounded-xl shadow-sm overflow-hidden border border-red-100 mb-6"><div class="bg-red-50 px-6 py-3 border-b border-red-100 flex justify-between items-center"><h3 class="font-bold text-red-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>${nomeGrupo}</h3><span class="bg-white text-red-600 text-xs px-2 py-1 rounded-full font-bold border border-red-200">${itens.length} itens</span></div><table class="w-full text-left"><tbody class="divide-y divide-red-50">${rows}</tbody></table></div>`;
                    }
                } else { emptyDiv.classList.remove('hidden'); }
            } catch(e) { console.error(e); } finally { setLoading(false); }
        }
    </script>
</body>
</html>
