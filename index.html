<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o RPPS - Controle Financeiro</title>
    
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (Ãcones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { background-color: #2563eb; color: white; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-section { display: none; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- SIDEBAR DE NAVEGAÃ‡ÃƒO -->
    <aside class="w-full md:w-64 bg-white shadow-lg flex flex-col z-20">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-blue-700"><i class="fas fa-university mr-2"></i>GestÃ£o RPPS</h1>
            <p class="text-xs text-gray-500 mt-1">Sistema de Controle Financeiro</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <button onclick="showView('resumo')" id="btn-resumo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center tab-active">
                <i class="fas fa-chart-pie w-6"></i> Resumo Financeiro
            </button>
            <button onclick="showView('folha')" id="btn-folha" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-users w-6"></i> Folha Pagamento
            </button>
            
            <!-- NOVO BOTÃƒO: 13Âº SALÃRIO -->
            <button onclick="showView('decimo')" id="btn-decimo" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center text-blue-800 font-medium">
                <i class="fas fa-gift w-6"></i> 13Âº SalÃ¡rio
            </button>

            <button onclick="showView('outros')" id="btn-outros" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-exchange-alt w-6"></i> Outros Bancos
            </button>
            <button onclick="showView('consignados')" id="btn-consignados" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-hand-holding-usd w-6"></i> Consignados
            </button>
            <button onclick="showView('adm')" id="btn-adm" class="nav-btn w-full text-left px-6 py-3 hover:bg-blue-50 transition-colors flex items-center">
                <i class="fas fa-file-invoice-dollar w-6"></i> Administrativo
            </button>
            <div class="border-t border-gray-100 my-2"></div>
            <button onclick="showView('pendencias')" id="btn-pendencias" class="nav-btn w-full text-left px-6 py-3 hover:bg-red-50 text-red-600 transition-colors flex items-center">
                <i class="fas fa-exclamation-circle w-6"></i> PendÃªncias
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">CompetÃªncia (MM/AAAA)</label>
            <div class="flex">
                <input type="text" id="globalCompetencia" class="w-full p-2 border rounded-l focus:outline-none focus:border-blue-500 text-center font-bold text-gray-700" placeholder="MM/AAAA" maxlength="7">
                <button onclick="carregarDadosAtuais()" class="bg-blue-600 text-white px-3 rounded-r hover:bg-blue-700">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- ÃREA PRINCIPAL -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100 relative">
        
        <!-- LOADING OVERLAY -->
        <div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center hidden">
            <div class="loader mb-4"></div>
            <p class="text-blue-600 font-semibold animate-pulse">Processando dados...</p>
        </div>

        <!-- CABEÃ‡ALHO MOBILE/DESKTOP -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center md:hidden">
            <span class="font-bold text-lg">RPPS</span>
            <button class="text-gray-600"><i class="fas fa-bars"></i></button>
        </header>

        <!-- CONTEÃšDO SCROLLÃVEL -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="mainContent">
            
            <!-- VIEW: RESUMO (DASHBOARD) -->
            <div id="view-resumo" class="view-section">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Resumo Financeiro</h2>
                        <p class="text-sm text-gray-500">VisÃ£o geral da competÃªncia <span class="current-comp font-bold text-blue-600">--/----</span></p>
                    </div>
                    <button onclick="carregarResumo()" class="text-sm text-blue-600 hover:underline"><i class="fas fa-sync mr-1"></i>Atualizar</button>
                </div>

                <!-- Cards de Totais -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Folha + 13 -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">ObrigaÃ§Ãµes (Folha + 13Âº)</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-folha">R$ 0,00</h3>
                                <p class="text-xs text-gray-400 mt-1" id="dash-sub-folha">Normal: 0 | 13Âº: 0</p>
                            </div>
                            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i class="fas fa-users"></i></div>
                        </div>
                    </div>

                    <!-- Outros Bancos -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Outros Bancos</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-outros">R$ 0,00</h3>
                            </div>
                            <div class="p-2 bg-orange-100 rounded-lg text-orange-600"><i class="fas fa-university"></i></div>
                        </div>
                    </div>

                    <!-- Bradesco Estimado -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">LÃ­quido Bradesco (Est.)</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-bradesco">R$ 0,00</h3>
                            </div>
                            <div class="p-2 bg-green-100 rounded-lg text-green-600"><i class="fas fa-money-check-alt"></i></div>
                        </div>
                    </div>

                    <!-- Consignados -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 uppercase font-bold">Consignados</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="dash-total-consig">R$ 0,00</h3>
                            </div>
                            <div class="p-2 bg-purple-100 rounded-lg text-purple-600"><i class="fas fa-hand-holding-usd"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de ConferÃªncia -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">ConferÃªncia da Folha (CÃ¡lculo Reverso)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">DescriÃ§Ã£o</th>
                                    <th class="px-4 py-3 text-right">Valor</th>
                                    <th class="px-4 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr>
                                    <td class="px-4 py-3 font-medium">Total (Folha Normal + 13Âº SalÃ¡rio)</td>
                                    <td class="px-4 py-3 text-right font-bold text-blue-600" id="conf-folha">R$ 0,00</td>
                                    <td class="px-4 py-3 text-center">-</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3">(-) Soma de Outros Bancos</td>
                                    <td class="px-4 py-3 text-right text-red-500" id="conf-outros">R$ 0,00</td>
                                    <td class="px-4 py-3 text-center">-</td>
                                </tr>
                                <tr class="bg-green-50">
                                    <td class="px-4 py-3 font-bold">(=) Total Previsto Bradesco</td>
                                    <td class="px-4 py-3 text-right font-bold text-green-700" id="conf-bradesco">R$ 0,00</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full">Calculado</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 text-sm rounded border border-yellow-200">
                        <i class="fas fa-info-circle mr-2"></i> <strong>AtenÃ§Ã£o:</strong> O valor "Previsto Bradesco" deve bater exatamente com o arquivo de remessa do banco.
                    </div>
                </div>
            </div>

            <!-- VIEW: FOLHA -->
            <div id="view-folha" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Folha de Pagamento</h2>
                    <button onclick="toggleModal('modal-folha')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Tipo</th>
                                <th class="px-6 py-3 text-right">Valor Total</th>
                                <th class="px-6 py-3">ObservaÃ§Ã£o</th>
                            </tr>
                        </thead>
                        <tbody id="lista-folha" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-folha" class="p-8 text-center text-gray-500 hidden">Nenhum registro encontrado.</div>
                </div>
            </div>

            <!-- VIEW: 13Âº SALÃRIO (NOVA) -->
            <div id="view-decimo" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-800">13Âº SalÃ¡rio</h2>
                        <p class="text-xs text-gray-500">Registro mensal para Aposentados, Pensionistas e Comissionados</p>
                    </div>
                    <button onclick="toggleModal('modal-decimo')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow">
                        <i class="fas fa-plus mr-2"></i>Adicionar 13Âº
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-blue-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-blue-50 text-blue-700 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Tipo BeneficiÃ¡rio</th>
                                <th class="px-6 py-3 text-right">Valor 13Âº</th>
                                <th class="px-6 py-3">ObservaÃ§Ã£o</th>
                            </tr>
                        </thead>
                        <tbody id="lista-decimo" class="divide-y divide-blue-50"></tbody>
                    </table>
                    <div id="empty-decimo" class="p-8 text-center text-gray-500 hidden">Nenhum registro de 13Âº nesta competÃªncia.</div>
                </div>
            </div>

            <!-- VIEW: OUTROS BANCOS -->
            <div id="view-outros" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Outros Bancos</h2>
                    <button onclick="toggleModal('modal-outros')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Nome</th>
                                <th class="px-6 py-3">Tipo</th>
                                <th class="px-6 py-3">Banco</th>
                                <th class="px-6 py-3 text-right">Valor</th>
                                <th class="px-6 py-3">Obs</th>
                            </tr>
                        </thead>
                        <tbody id="lista-outros" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-outros" class="p-8 text-center text-gray-500 hidden">Nenhum registro encontrado.</div>
                </div>
            </div>

            <!-- VIEW: CONSIGNADOS -->
            <div id="view-consignados" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Consignados</h2>
                    <button onclick="toggleModal('modal-consignados')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm shadow">
                        <i class="fas fa-plus mr-2"></i>Adicionar
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Tipo Consignado</th>
                                <th class="px-6 py-3 text-right">Valor</th>
                                <th class="px-6 py-3">Obs</th>
                            </tr>
                        </thead>
                        <tbody id="lista-consignados" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-consignados" class="p-8 text-center text-gray-500 hidden">Nenhum registro encontrado.</div>
                </div>
            </div>

            <!-- VIEW: ADMINISTRATIVO (RECORRENTES + OUTROS) -->
            <div id="view-adm" class="view-section hidden-section">
                
                <!-- Recorrentes -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Pagamentos Recorrentes</h3>
                        <button onclick="toggleModal('modal-recorrentes')" class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs shadow">
                            <i class="fas fa-plus mr-1"></i> Novo Recorrente
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">DescriÃ§Ã£o</th>
                                    <th class="px-6 py-3">Tipo</th>
                                    <th class="px-6 py-3 text-right">Valor</th>
                                    <th class="px-6 py-3 text-center">Status</th>
                                    <th class="px-6 py-3 text-center">AÃ§Ã£o</th>
                                </tr>
                            </thead>
                            <tbody id="lista-recorrentes" class="divide-y divide-gray-100"></tbody>
                        </table>
                        <div id="empty-recorrentes" class="p-8 text-center text-gray-500 hidden">Nenhum recorrente nesta competÃªncia.</div>
                    </div>
                </div>

                <!-- Eventuais -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Pagamentos Eventuais</h3>
                        <button onclick="toggleModal('modal-eventuais')" class="bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 text-xs shadow">
                            <i class="fas fa-plus mr-1"></i> Novo Eventual
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">DescriÃ§Ã£o</th>
                                    <th class="px-6 py-3 text-right">Valor</th>
                                    <th class="px-6 py-3 text-center">Status</th>
                                    <th class="px-6 py-3 text-center">AÃ§Ã£o</th>
                                </tr>
                            </thead>
                            <tbody id="lista-eventuais" class="divide-y divide-gray-100"></tbody>
                        </table>
                        <div id="empty-eventuais" class="p-8 text-center text-gray-500 hidden">Nenhum pagamento eventual.</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PENDÃŠNCIAS -->
            <div id="view-pendencias" class="view-section hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-600">PendÃªncias em Aberto</h2>
                    <button onclick="carregarPendencias()" class="text-sm text-gray-600 hover:text-gray-900">
                        <i class="fas fa-sync mr-1"></i>Atualizar Lista
                    </button>
                </div>

                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <p class="text-sm text-red-800"><i class="fas fa-info-circle mr-2"></i>Esta lista exibe todos os pagamentos marcados como "Pendente" em qualquer competÃªncia. Regularize marcando como "Pago" na aba de origem ou aqui (futuro).</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">CompetÃªncia</th>
                                <th class="px-6 py-3">Origem</th>
                                <th class="px-6 py-3">DescriÃ§Ã£o / Nome</th>
                                <th class="px-6 py-3 text-right">Valor</th>
                                <th class="px-6 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="lista-pendencias" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <div id="empty-pendencias" class="p-8 text-center text-gray-500 hidden">Nenhuma pendÃªncia encontrada! ðŸŽ‰</div>
                </div>
            </div>

        </div>
    </main>

    <!-- MODAIS -->

    <!-- Modal Adicionar Folha -->
    <div id="modal-folha" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Folha</h3>
            <form onsubmit="handleSubmit(event, 'adicionarFolha')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Tipo de Folha</label>
                    <select name="tipo" class="w-full border rounded p-2" required>
                        <option value="Aposentados">Aposentados</option>
                        <option value="Pensionistas">Pensionistas</option>
                        <option value="Comissionados">Comissionados</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Valor Total</label>
                    <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-folha')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adicionar 13Âº (NOVO) -->
    <div id="modal-decimo" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 border-t-4 border-blue-600">
            <h3 class="font-bold text-lg mb-4 text-blue-800">Adicionar 13Âº SalÃ¡rio</h3>
            <form onsubmit="handleSubmit(event, 'adicionarDecimo')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Tipo de BeneficiÃ¡rio</label>
                    <select name="tipo" class="w-full border rounded p-2" required>
                        <option value="Aposentados">Aposentados</option>
                        <option value="Pensionistas">Pensionistas</option>
                        <option value="Comissionados">Comissionados</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Valor 13Âº</label>
                    <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-decimo')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Outros Bancos -->
    <div id="modal-outros" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Outro Banco</h3>
            <form onsubmit="handleSubmit(event, 'adicionarOutrosBancos')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nome</label>
                    <input type="text" name="nome" class="w-full border rounded p-2" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label>
                        <select name="tipo" class="w-full border rounded p-2">
                            <option value="Aposentado">Aposentado</option>
                            <option value="Pensionista">Pensionista</option>
                            <option value="Comissionado">Comissionado</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Banco</label>
                        <input type="text" name="banco" class="w-full border rounded p-2" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Valor</label>
                    <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-outros')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Consignados -->
    <div id="modal-consignados" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Consignado</h3>
            <form onsubmit="handleSubmit(event, 'adicionarConsignado')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Tipo / Banco</label>
                    <input type="text" name="tipo" class="w-full border rounded p-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Valor</label>
                    <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-consignados')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Recorrentes -->
    <div id="modal-recorrentes" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Pagamento Recorrente</h3>
            <form onsubmit="handleSubmit(event, 'adicionarRecorrente')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">DescriÃ§Ã£o</label>
                    <input type="text" name="descricao" class="w-full border rounded p-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">Tipo</label>
                    <select name="tipo" class="w-full border rounded p-2">
                        <option value="Assessoria">Assessoria</option>
                        <option value="ServiÃ§o">ServiÃ§o</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Valor</label>
                        <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">SituaÃ§Ã£o Inicial</label>
                        <select name="situacao" class="w-full border rounded p-2">
                            <option value="Pendente">Pendente</option>
                            <option value="Pago">Pago</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-recorrentes')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Modal Eventuais -->
     <div id="modal-eventuais" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Pagamento Eventual</h3>
            <form onsubmit="handleSubmit(event, 'adicionarOutroPagamento')">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">DescriÃ§Ã£o</label>
                    <input type="text" name="descricao" class="w-full border rounded p-2" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Valor</label>
                        <input type="text" name="valor" class="money-mask w-full border rounded p-2" placeholder="0,00" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">SituaÃ§Ã£o Inicial</label>
                        <select name="situacao" class="w-full border rounded p-2">
                            <option value="Pendente">Pendente</option>
                            <option value="Pago">Pago</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ObservaÃ§Ã£o</label>
                    <input type="text" name="obs" class="w-full border rounded p-2">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="toggleModal('modal-eventuais')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // CONFIGURAÃ‡ÃƒO
        const API_URL = "https://script.google.com/macros/s/AKfycbwt5wH_wT65wfXyaBc78YK4ZBHcCi7zFATSQRk6yytCTHFlqCLs1Gc7JSS395aYNUmR/exec";
        
        let currentCompetencia = "";

        window.onload = function() {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            currentCompetencia = `${mm}/${yyyy}`;
            document.getElementById('globalCompetencia').value = currentCompetencia;
            carregarResumo();
            setupMoneyMask();
        };

        function showView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`view-${viewName}`).classList.remove('hidden-section');
            document.getElementById(`btn-${viewName}`).classList.add('tab-active');

            if (viewName === 'resumo') carregarResumo();
            if (viewName === 'folha') carregarListaGenerica('FOLHA_PAGAMENTO', 'lista-folha', 'empty-folha', renderRowFolha);
            if (viewName === 'decimo') carregarListaGenerica('DECIMO_TERCEIRO', 'lista-decimo', 'empty-decimo', renderRowDecimo);
            if (viewName === 'outros') carregarListaGenerica('OUTROS_BANCOS', 'lista-outros', 'empty-outros', renderRowOutros);
            if (viewName === 'consignados') carregarListaGenerica('CONSIGNADOS', 'lista-consignados', 'empty-consignados', renderRowConsig);
            if (viewName === 'adm') {
                carregarListaGenerica('PAGAMENTOS_RECORRENTES', 'lista-recorrentes', 'empty-recorrentes', renderRowRecorrente);
                carregarListaGenerica('OUTROS_PAGAMENTOS', 'lista-eventuais', 'empty-eventuais', renderRowEventual);
            }
            if (viewName === 'pendencias') carregarPendencias();
        }

        function toggleModal(modalId) {
            document.getElementById(modalId).classList.toggle('hidden');
        }

        function updateCompetenciaGlobal() {
            const val = document.getElementById('globalCompetencia').value;
            if(!/^\d{2}\/\d{4}$/.test(val)) {
                alert("Formato de competÃªncia invÃ¡lido. Use MM/AAAA");
                return false;
            }
            currentCompetencia = val;
            document.querySelectorAll('.current-comp').forEach(el => el.innerText = currentCompetencia);
            return true;
        }

        function carregarDadosAtuais() {
            if(updateCompetenciaGlobal()) {
                const activeBtn = document.querySelector('.nav-btn.tab-active');
                if(activeBtn) activeBtn.click();
            }
        }

        async function carregarResumo() {
            updateCompetenciaGlobal();
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getResumoMensal&competencia=${currentCompetencia}`);
                const json = await response.json();
                
                if(json.status === 'success') {
                    // Atualiza Cards
                    document.getElementById('dash-total-folha').innerText = formatCurrency(json.folha.total_geral);
                    document.getElementById('dash-sub-folha').innerText = `Normal: ${formatCurrency(json.folha.total_normal)} | 13Âº: ${formatCurrency(json.folha.total_decimo)}`;
                    
                    document.getElementById('dash-total-outros').innerText = formatCurrency(json.bancos.outros_bancos);
                    document.getElementById('dash-total-bradesco').innerText = formatCurrency(json.bancos.bradesco_estimado);
                    document.getElementById('dash-total-consig').innerText = formatCurrency(json.consignados.total);
                    
                    // Atualiza Tabela
                    document.getElementById('conf-folha').innerText = formatCurrency(json.folha.total_geral);
                    document.getElementById('conf-outros').innerText = formatCurrency(json.bancos.outros_bancos);
                    document.getElementById('conf-bradesco').innerText = formatCurrency(json.bancos.bradesco_estimado);
                }
            } catch (error) { console.error(error); alert("Erro ao conectar com o servidor."); } 
            finally { setLoading(false); }
        }

        async function carregarListaGenerica(sheetName, tbodyId, emptyId, renderFunction) {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getList&sheet=${sheetName}&competencia=${currentCompetencia}`);
                const json = await response.json();
                
                const tbody = document.getElementById(tbodyId);
                const emptyDiv = document.getElementById(emptyId);
                tbody.innerHTML = '';

                if(json.status === 'success' && json.data.length > 0) {
                    emptyDiv.classList.add('hidden');
                    json.data.forEach(row => tbody.innerHTML += renderFunction(row));
                } else {
                    emptyDiv.classList.remove('hidden');
                }
            } catch(e) { console.error(e); } 
            finally { setLoading(false); }
        }

        async function carregarPendencias() {
            setLoading(true);
            try {
                const response = await fetch(`${API_URL}?action=getPendencias`);
                const json = await response.json();
                const tbody = document.getElementById('lista-pendencias');
                const emptyDiv = document.getElementById('empty-pendencias');
                tbody.innerHTML = '';

                if(json.status === 'success' && json.data.length > 0) {
                    emptyDiv.classList.add('hidden');
                    json.data.forEach(row => {
                        tbody.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-700">${row[0]}</td>
                                <td class="px-6 py-4"><span class="bg-gray-200 text-gray-700 py-1 px-2 rounded text-xs">${row[1]}</span></td>
                                <td class="px-6 py-4">${row[2]}</td>
                                <td class="px-6 py-4 text-right font-medium">${formatCurrency(row[3])}</td>
                                <td class="px-6 py-4 text-center"><span class="text-red-600 font-bold text-xs bg-red-100 px-2 py-1 rounded">PENDENTE</span></td>
                            </tr>
                        `;
                    });
                } else { emptyDiv.classList.remove('hidden'); }
            } catch(e) { console.error(e); } 
            finally { setLoading(false); }
        }

        function renderRowFolha(row) {
            return `<tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="px-6 py-4 font-medium text-gray-900">${row[1]}</td>
                    <td class="px-6 py-4 text-right font-bold text-blue-600">${formatCurrency(row[2])}</td>
                    <td class="px-6 py-4 text-gray-500 text-xs">${row[3]}</td>
                </tr>`;
        }

        function renderRowDecimo(row) {
            return `<tr class="hover:bg-blue-50 border-b border-blue-100 last:border-0">
                    <td class="px-6 py-4 font-medium text-blue-900">${row[1]}</td>
                    <td class="px-6 py-4 text-right font-bold text-blue-700">${formatCurrency(row[2])}</td>
                    <td class="px-6 py-4 text-blue-500 text-xs">${row[3]}</td>
                </tr>`;
        }

        function renderRowOutros(row) {
            return `<tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="px-6 py-4 font-medium">${row[1]}</td>
                    <td class="px-6 py-4 text-xs text-gray-500">${row[2]}</td>
                    <td class="px-6 py-4 text-sm">${row[3]}</td>
                    <td class="px-6 py-4 text-right font-bold text-orange-600">${formatCurrency(row[4])}</td>
                    <td class="px-6 py-4 text-gray-500 text-xs">${row[5]}</td>
                </tr>`;
        }

        function renderRowConsig(row) {
            return `<tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="px-6 py-4 font-medium">${row[1]}</td>
                    <td class="px-6 py-4 text-right font-bold text-purple-600">${formatCurrency(row[2])}</td>
                    <td class="px-6 py-4 text-gray-500 text-xs">${row[3]}</td>
                </tr>`;
        }

        function renderRowRecorrente(row) { return renderRowAdmin(row, 6, 1, 2, 3, 4, 'Recorrente'); }
        function renderRowEventual(row) { return renderRowAdmin(row, 5, 1, null, 2, 3, 'Eventual'); }

        function renderRowAdmin(row, idIndex, descIndex, tipoIndex, valIndex, statusIndex, origem) {
            const id = row[idIndex];
            const status = row[statusIndex];
            const badgeClass = status === 'Pago' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            const btnAction = status === 'Pendente' 
                ? `<button onclick="marcarComoPago('${id}', '${origem}')" class="text-green-600 hover:text-green-800 text-xs font-bold border border-green-600 px-2 py-1 rounded">PAGAR</button>` 
                : `<i class="fas fa-check text-green-500"></i>`;
            return `<tr class="hover:bg-gray-50 border-b last:border-0">
                    <td class="px-6 py-4 font-medium text-gray-900">${row[descIndex]} <br> <span class="text-xs text-gray-400">${tipoIndex ? row[tipoIndex] : ''}</span></td>
                    <td class="px-6 py-4 text-right font-bold">${formatCurrency(row[valIndex])}</td>
                    <td class="px-6 py-4 text-center"><span class="${badgeClass} px-2 py-1 rounded text-xs font-bold">${status}</span></td>
                    <td class="px-6 py-4 text-center">${btnAction}</td>
                </tr>`;
        }

        async function handleSubmit(event, action) {
            event.preventDefault();
            setLoading(true);
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            data.action = action;
            data.competencia = currentCompetencia;

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
                const json = await response.json();
                if(json.status === 'success') {
                    alert("Salvo com sucesso!");
                    event.target.reset();
                    document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
                    const activeBtn = document.querySelector('.nav-btn.tab-active');
                    if(activeBtn) activeBtn.click();
                } else { alert("Erro ao salvar: " + json.message); }
            } catch(e) { console.error(e); alert("Erro de comunicaÃ§Ã£o."); } 
            finally { setLoading(false); }
        }

        async function marcarComoPago(id, origem) {
            if(!confirm("Confirmar o pagamento deste registro?")) return;
            setLoading(true);
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'atualizarStatusPagamento', id: id, origem: origem, novoStatus: 'Pago' }) });
                const json = await response.json();
                if(json.status === 'success') document.querySelector('.nav-btn.tab-active').click();
            } catch(e) { console.error(e); } finally { setLoading(false); }
        }

        function setLoading(active) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !active);
        }

        function formatCurrency(val) {
            if(val === undefined || val === null) return "R$ 0,00";
            return parseFloat(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function setupMoneyMask() {
            document.querySelectorAll('.money-mask').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, "");
                    value = (value / 100).toFixed(2) + "";
                    value = value.replace(".", ",");
                    value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                    e.target.value = "R$ " + value;
                });
            });
        }
    </script>
</body>
</html>
